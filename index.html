<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dino Quest ‚Äî Reboot v1 (Phaser)</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
<style>
  html,body{height:100%;margin:0;background:#0b1020;font-family:Inter,system-ui}
  #game{width:100vw;height:100vh;overflow:hidden}
  .hud{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:linear-gradient(180deg,rgba(10,15,30,.7),transparent);pointer-events:none;z-index:5}
  .hud .row{display:flex;gap:8px;pointer-events:auto}
  .badge{display:flex;gap:8px;align-items:center;padding:8px 12px;border-radius:12px;border:1px solid #1f2b44;background:linear-gradient(180deg,#0f1a2c,#0b1422);color:#e6f0ff;font-weight:800}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #20304d;background:linear-gradient(180deg,#0f1c32,#0a1322);color:#e8f0ff;font-weight:800;cursor:pointer}
  .btn.on{outline:2px solid #5564ff}
  .overlay{position:fixed;inset:0;display:none;grid-template-rows:64px 1fr;background:rgba(8,12,24,.88);backdrop-filter:blur(8px);z-index:10}
  .overlay.show{display:grid}
  .overTop{display:flex;align-items:center;gap:8px;padding:12px}
  .cards{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));padding:0 16px 16px}
  .card{border:1px solid #233352;background:linear-gradient(180deg,#0e1a30,#0a1424);color:#def;border-radius:14px;padding:12px;text-align:center;transform:scale(.9);opacity:0;box-shadow:0 12px 28px #0006}
  .card.show{animation:pop .25s ease-out forwards}
  .em{font-size:42px;margin:8px 0}
  .rn{font-weight:900}
  .r-basic{box-shadow:0 0 0 1px #6b7b93 inset, 0 0 22px #6b7b9333}
  .r-rare {box-shadow:0 0 0 1px #38bdf8 inset, 0 0 26px #38bdf859}
  .r-epic {box-shadow:0 0 0 1px #a78bfa inset, 0 0 28px #a78bfa66}
  .r-leg  {box-shadow:0 0 0 1px #f59e0b inset, 0 0 30px #f59e0b66}
  .r-sup  {box-shadow:0 0 0 1px #22d3b6 inset, 0 0 32px #22d3b666}
  @keyframes pop{from{transform:scale(.6);opacity:0}to{transform:scale(1);opacity:1}}
</style>
</head>
<body>
<div id="game"></div>

<!-- HUD (HTML) -->
<div class="hud" id="hud">
  <div class="row">
    <div class="badge">Lvl&nbsp;<span id="lvl">1</span></div>
    <div class="badge">ü™ô&nbsp;<span id="gold">0</span></div>
    <div class="badge">üíé&nbsp;<span id="gems">0</span></div>
  </div>
  <div class="row">
    <button class="btn" id="btnMenu">‚ò∞ Menu</button>
    <button class="btn on" data-speed="1">x1</button>
    <button class="btn" data-speed="2">x2</button>
    <button class="btn" data-speed="3">x3</button>
  </div>
</div>

<!-- Overlay (Tirage / Am√©lioration / Inventaire) -->
<div class="overlay" id="overlay">
  <div class="overTop">
    <button class="btn" id="closeOverlay">‚Üê Retour</button>
    <div class="badge" id="overlayTitle">Tirage</div>
    <div style="margin-left:auto" class="row" id="overlayActions"></div>
  </div>
  <div class="cards" id="overWrap"></div>
</div>

<script>
/* ======= State & Utils ======= */
const rc = {BASIC:'#6b7b93', RARE:'#38bdf8', EPIC:'#a78bfa', LEG:'#f59e0b', SUP:'#22d3b6'};
const rarityKey = r => r==='SUP'?'r-sup':r==='LEG'?'r-leg':r==='EPIC'?'r-epic':r==='RARE'?'r-rare':'r-basic';
const nf = n => Math.floor(n).toLocaleString('fr-FR');

let S = JSON.parse(localStorage.getItem('dq_reboot')||'null') || {
  lvl:1, gold:0, gems:0, speed:1,
  hero:{ name:'Raptor', emoji:'ü¶ï', rarity:'BASIC', hp:120, cur:120, atk:10, def:3, spd:1.2 },
  enemy:null,
  bag:[],
  coll:[{id:'raptor', name:'Petit Raptor', emoji:'ü¶ï', rarity:'BASIC', hp:120, atk:10, def:3, spd:1.2}],
};
function save(){ localStorage.setItem('dq_reboot', JSON.stringify(S)); }
function ui(){ document.getElementById('lvl').textContent=S.lvl; document.getElementById('gold').textContent=nf(S.gold); document.getElementById('gems').textContent=nf(S.gems); }

/* ======= Phaser Game ======= */
class Battle extends Phaser.Scene {
  constructor(){ super('battle'); }

  preload(){}

  create(){
    // Parallax jungle (proc√©dural)
    const w=this.scale.width, h=this.scale.height;
    this.cameras.main.setBackgroundColor('#0a1322');

    this.bg1 = this.add.graphics().fillStyle(0x0c1a2e,1).fillRect(0,0,w,h);
    this.bg2 = this.add.graphics().fillStyle(0x0a2238,1).fillEllipse(w*0.25,h*0.9, w*0.9, 80);
    this.bg3 = this.add.graphics().fillStyle(0x0a2238,1).fillEllipse(w*0.75,h*0.92, w*1.1, 90);

    // decorative trees
    this.trees = this.add.group();
    for(let i=0;i<12;i++){
      const x = Math.random()*w, y = h*0.6 + Math.random()*h*0.35;
      const g=this.add.graphics();
      g.fillStyle(0x13334f,1).fillEllipse(x,y, 40, 18);
      g.fillStyle(0x1b3d5e,1).fillTriangle(x-10,y, x+10,y, x, y-40-Math.random()*20);
      this.trees.add(g);
    }

    // Sprites placeholders (ronds lumineux + emoji centr√©s)
    this.allyBase = this.add.circle(w*0.25, h*0.75, 42, 0x123a6b).setStrokeStyle(3,0x2b7fff,0.9);
    this.enemyBase= this.add.circle(w*0.75, h*0.55, 42, 0x5b1222).setStrokeStyle(3,0xff3b5b,0.9);

    this.allyEmoji = this.add.text(this.allyBase.x, this.allyBase.y-6, S.hero.emoji, {fontFamily:'sans-serif', fontSize:48}).setOrigin(0.5);
    this.enemyEmoji= this.add.text(this.enemyBase.x, this.enemyBase.y-6, 'ü¶é', {fontFamily:'sans-serif', fontSize:48}).setOrigin(0.5);

    // HP bars
    this.allyHP = this.add.rectangle(this.allyBase.x-70, this.allyBase.y+50, 140, 10, 0x0b1220).setOrigin(0,0.5);
    this.allyFill= this.add.rectangle(this.allyHP.x, this.allyHP.y, 140, 10, 0x28d0ff).setOrigin(0,0.5);
    this.enemyHP = this.add.rectangle(this.enemyBase.x-70, this.enemyBase.y-60, 140, 10, 0x0b1220).setOrigin(0,0.5);
    this.enemyFill= this.add.rectangle(this.enemyHP.x, this.enemyHP.y, 140, 10, 0x7dd3fc).setOrigin(0,0.5);

    // Enemy stats
    this.newEnemy();

    // Idle tween
    this.tweens.add({targets:[this.allyEmoji], y:this.allyBase.y-10, yoyo:true, duration:1200, repeat:-1, ease:'Sine.inOut'});
    this.tweens.add({targets:[this.enemyEmoji], y:this.enemyBase.y-10, yoyo:true, duration:1400, repeat:-1, ease:'Sine.inOut'});

    // Timers d‚Äôattaque
    this.nextAlly = 0;
    this.nextEnemy= 0;

    // Vitesse
    this.timeScale = 1;
    ui();
  }

  newEnemy(){
    const lvl=S.lvl;
    const hp = 90 + lvl*24;
    const atk= 7 + Math.floor(lvl*1.6);
    const def= 2 + Math.floor(lvl*0.6);
    S.enemy = {name:`Pr√©dateur Niv. ${lvl}`, emoji:'ü¶é', hp, cur:hp, atk, def};
    this.enemyEmoji.setText(S.enemy.emoji);
    this.updateBars();
  }

  updateBars(){
    const aRatio = Phaser.Math.Clamp(S.hero.cur / S.hero.hp, 0, 1);
    const eRatio = Phaser.Math.Clamp(S.enemy.cur / S.enemy.hp, 0, 1);
    this.allyFill.width = 140 * aRatio;
    this.enemyFill.width = 140 * eRatio;
  }

  damagePop(x,y,txt,color=0xffffff){
    const t = this.add.text(x,y,txt,{fontFamily:'sans-serif',fontSize:22,color:'#fff'}).setOrigin(0.5);
    t.setTint(color);
    this.tweens.add({targets:t, y:y-30, alpha:0, duration:450, ease:'Quad.out', onComplete:()=>t.destroy()});
    // particules cercle
    const p=this.add.particles(0,0,''); // dummy
    const emitter=p.createEmitter({
      x, y, speed:{min:-90,max:90}, angle:{min:0,max:360}, lifespan:300, quantity:12, scale:{start:0.5,end:0}, tint:color
    });
    this.time.delayedCall(300,()=>p.destroy());
  }

  shake(){ this.cameras.main.shake(90, 0.003); }

  update(time, delta){
    const dt = delta/1000 * (S.speed||1);

    // Ally attack
    this.nextAlly -= dt;
    if(this.nextAlly<=0){
      this.nextAlly = Math.max(.5, S.hero.spd);
      const dmg = Math.max(1, S.hero.atk - Math.floor(S.enemy.def*0.35));
      S.enemy.cur = Math.max(0, S.enemy.cur - dmg);
      this.damagePop(this.enemyBase.x, this.enemyBase.y-70, `-${dmg}`, 0x87e8ff);
      this.shake();
      this.updateBars();
    }

    // Enemy attack
    this.nextEnemy -= dt;
    if(this.nextEnemy<=0){
      this.nextEnemy = 1.2;
      const dmg = Math.max(1, S.enemy.atk - S.hero.def);
      S.hero.cur = Math.max(0, S.hero.cur - dmg);
      this.damagePop(this.allyBase.x, this.allyBase.y-70, `-${dmg}`, 0xff879a);
      this.updateBars();
    }

    // Win / Lose
    if(S.enemy.cur<=0){
      const gold = 10 + S.lvl*6;
      S.gold += gold;
      if(S.lvl%15===0) S.gems += 10;
      S.lvl++; S.hero.cur = Math.min(S.hero.hp, S.hero.cur+8);
      ui(); save();
      this.newEnemy();
      // reward pop
      this.damagePop(this.enemyBase.x, this.enemyBase.y-90, `+${gold} ü™ô`, 0xffd37a);
    }else if(S.hero.cur<=0){
      // reset h√©ro et on retente
      S.hero.cur = S.hero.hp; save();
      this.damagePop(this.allyBase.x, this.allyBase.y-90, `Re-tente !`, 0xaab7ff);
    }
  }
}

/* ======= Boot Phaser ======= */
const game = new Phaser.Game({
  type: Phaser.AUTO,
  parent: 'game',
  backgroundColor: '#0b1020',
  scale: { mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH, width: 800, height: 480 },
  scene: [Battle],
  physics: { default: 'arcade' }
});

/* ======= HUD JS (HTML overlay) ======= */
function showOverlay(title, actions=[], content=[]){
  const o=document.getElementById('overlay'), t=document.getElementById('overlayTitle'), a=document.getElementById('overlayActions'), w=document.getElementById('overWrap');
  t.textContent=title; a.innerHTML=""; w.innerHTML="";
  actions.forEach(b=>{ const el=document.createElement('button'); el.className='btn'; el.textContent=b.label; el.onclick=b.onClick; a.appendChild(el); });
  content.forEach((c,i)=>{ const el=document.createElement('div'); el.className=`card ${rarityKey(c.rarity)} show`; el.style.animationDelay=(i*120)+'ms';
    el.innerHTML=`<div class="em">${c.emoji||'üéÅ'}</div><div class="rn" style="color:${rc[c.rarity]||'#9cf'}">${c.rarity||''}</div><div>${c.name||''}</div>${c.extra?`<div style="opacity:.8">${c.extra}</div>`:''}`;
    w.appendChild(el);
  });
  o.classList.add('show');
}
function hideOverlay(){ document.getElementById('overlay').classList.remove('show'); }

/* ======= Menu & Actions ======= */
document.getElementById('btnMenu').onclick=()=>{
  showOverlay('Menu',[
    {label:'üé¥ Tirage', onClick:openSummon},
    {label:'üõ†Ô∏è Am√©liorer', onClick:openImprove},
    {label:'üéí Inventaire', onClick:openBag},
    {label:'üéüÔ∏è Code promo', onClick:openPromo}
  ],[]);
};
document.getElementById('closeOverlay').onclick=hideOverlay;

// Speed buttons
document.querySelectorAll('[data-speed]').forEach(b=>{
  b.onclick=()=>{ document.querySelectorAll('[data-speed]').forEach(x=>x.classList.remove('on')); b.classList.add('on'); S.speed=+b.dataset.speed; save(); };
});

/* ======= Systems ======= */
function rollRarity(kind){ const r=Math.random(); if(kind==='item'){ if(r<.55)return'BASIC'; if(r<.83)return'RARE'; if(r<.95)return'EPIC'; if(r<.995)return'LEG'; return'SUP'; } else { if(r<.50)return'BASIC'; if(r<.80)return'RARE'; if(r<..94)return'EPIC'; if(r<.995)return'LEG'; return'SUP'; } }
function grantItem(r){ const list=[ {name:'Griffe aiguis√©e',emoji:'üó°Ô∏è',val:'+4 ATK'}, {name:'Cuirasse osseuse',emoji:'üõ°Ô∏è',val:'+2 DEF'}, {name:'√âcaille vitale',emoji:'‚ù§Ô∏è',val:'+20 PV'} ]; const base=list[Math.floor(Math.random()*list.length)]; return {rarity:r,name:base.name,emoji:'üéÅ',extra:base.val}; }
function grantDino(r){ const pool=[ {name:'Petit Raptor',emoji:'ü¶ï'}, {name:'Trihorn',emoji:'ü¶ñ'}, {name:'A√©ropt√®re',emoji:'ü¶Ö'}, {name:'Rex Alpha',emoji:'ü¶Ç'}, {name:'Spino Supr√™me',emoji:'üêâ'} ]; const d=pool[Math.floor(Math.random()*pool.length)]; S.coll.push({id:crypto.randomUUID(),name:d.name,emoji:d.emoji,rarity:r}); return {rarity:r,name:d.name,emoji:d.emoji}; }

function openSummon(){
  const actions=[
    {label:'Tirage x1 (100üíé)', onClick:()=>doPull(1)},
    {label:'Tirage x10 (900üíé)', onClick:()=>doPull(10)}
  ];
  showOverlay('Tirage', actions, []);
}
function doPull(n){
  const cost = n===10?900:100; if(S.gems<cost){alert('Pas assez de gemmes');return;}
  S.gems-=cost; ui(); save();
  const out=[];
  for(let i=0;i<n;i++){
    if(Math.random()<0.6){ out.push(grantDino(rollRarity('dino'))); }
    else{ out.push(grantItem(rollRarity('item'))); }
  }
  showOverlay('R√©sultats', [{label:'OK',onClick:hideOverlay}], out);
}

function openImprove(){
  const actions=[{label:'Fermer',onClick:hideOverlay},{label:'+ATK (500ü™ô)',onClick:()=>upd('atk')},{label:'+PV (500ü™ô)',onClick:()=>upd('hp')}];
  const hero=S.hero;
  showOverlay('Am√©liorer', actions, [{rarity:hero.rarity,name:`${hero.emoji} ${hero.name}`,emoji:hero.emoji,extra:`Niv ${S.lvl} ‚Ä¢ PV ${hero.cur}/${hero.hp} ‚Ä¢ ATK ${hero.atk} ‚Ä¢ DEF ${hero.def}`}]);
  function upd(kind){
    if(S.gold<500){alert('Pas assez d‚Äôor');return;}
    S.gold-=500;
    if(kind==='atk') S.hero.atk+=2;
    if(kind==='hp'){ S.hero.hp+=20; S.hero.cur+=20; }
    ui(); save();
    openImprove();
  }
}

function openBag(){
  const content=(S.bag.length? S.bag : [{rarity:'BASIC',name:'Inventaire vide',emoji:'üì¶'}]);
  showOverlay('Inventaire',[{label:'Fermer',onClick:hideOverlay}],content);
}

function openPromo(){
  const actions=[{label:'MEGA-START', onClick:()=>{ if(!localStorage.getItem('promo_ms')){localStorage.setItem('promo_ms','1'); S.gold+=200000; S.gems+=50000; ui(); save(); alert('Bonus appliqu√©'); } else alert('D√©j√† utilis√©'); }}];
  showOverlay('Code promo', actions, [{rarity:'LEG',name:'Astuce',emoji:'üéüÔ∏è',extra:'MEGA-START ‚Üí +200k or +50k gemmes'}]);
}

/* init HUD on load */
ui();
</script>
</body>
</html>
