<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dino Quest</title>
<style>
  :root{
    --bg:#0a0f1e;
    --panel:#0f162b;
    --panel-2:#0c1224;
    --border:#1e2a4a;
    --gold:#d2d8e6;
    --gems:#8fd7ff;
    --hp:#2fd0ff;
    --ring:#0c132a;
    --good:#64e0b6;
    --bad:#ff6b6b;
    --accent:#7de3ff;
    --accent-2:#75c5ff;
    --purple:#6c63ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);color:#dbe6ff;font-family:Inter,system-ui,Roboto,Arial,sans-serif;margin:0}
  button{cursor:pointer}
  .hud{position:fixed;top:0;left:0;right:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:linear-gradient(180deg,#0f162b,#0b1220);border-bottom:1px solid var(--border);z-index:40}
  .brand{font-weight:800;letter-spacing:.5px}
  .badges{display:flex;gap:10px;align-items:center;font-weight:700}
  .badge{padding:6px 10px;border:1px solid var(--border);border-radius:12px;background:var(--panel);display:flex;gap:6px;align-items:center}
  .i{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center}
  .ham{width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:var(--panel);display:grid;place-items:center}
  .ham div{width:16px;height:2px;background:#cfe3ff;border-radius:2px;box-shadow:0 6px 0 #cfe3ff,0 -6px 0 #cfe3ff}
  /* Scene */
  .stage{position:fixed;inset:56px 0 0 0;overflow:hidden}
  .scene{position:absolute;inset:0; background:
     radial-gradient(1200px 600px at 50% 120%, #0b341c40, transparent),
     radial-gradient(600px 300px at 75% 20%, #2d1a3d40, transparent),
     radial-gradient(800px 400px at 25% 35%, #15374a40, transparent),
     linear-gradient(180deg,#091225 0%, #07101f 55%, #070d18 100%);
  }
  /* dÃ©cor simple (arbres/roches) */
  .deco{position:absolute;opacity:.35;filter:blur(0.3px)}
  .tree{width:10px;height:60px;background:#163c3c;border-radius:4px;box-shadow:
    0 -14px 16px 6px #1b6a6a inset,
    0 -30px 20px 10px #215151 inset;
    transform:translate(-50%,-50%);
  }
  .lava{position:absolute;width:220px;height:20px;background:linear-gradient(90deg,#ff6b3d,#ffdd59,#ff6b3d);border-radius:50%;filter:blur(4px);opacity:.25}
  /* enemy & ally cards */
  .card{position:absolute;min-width:260px;max-width:300px;background:rgba(15,22,43,.9);border:1px solid var(--border);border-radius:16px;padding:12px 12px 10px 12px;box-shadow:0 8px 26px #0008}
  .card h3{margin:0 0 6px 0;font-size:18px}
  .line{height:9px;background:#0a1b2e;border-radius:10px;border:1px solid #09203a;overflow:hidden}
  .hp{height:100%;background:linear-gradient(90deg,#2fd0ff,#7de3ff);width:100%;transition:width .25s}
  .stats{opacity:.8;font-size:12px;margin-top:6px}
  .enemy{right:18px;top:96px}
  .ally{left:18px;bottom:120px}
  .allyRow{display:flex;gap:12px;align-items:flex-end}
  .allyMini{position:relative;width:140px}
  .allyMini h4{margin:0 0 4px 0}
  .allyMini .line{height:8px}
  .sprite{position:absolute;bottom:18px;left:18px;width:96px;height:96px;transform-origin:center;transition:transform .2s}
  .enemySprite{position:absolute;top:160px;right:60px;width:96px;height:96px}
  .fx{position:absolute;pointer-events:none;mix-blend-mode:screen}
  @keyframes hit {
    0%{transform:translate(0,0)}
    30%{transform:translate(8px,-6px)}
    60%{transform:translate(-6px,5px)}
    100%{transform:translate(0,0)}
  }
  /* speed panel */
  .speed{position:fixed;right:14px;bottom:18px;display:flex;gap:10px;align-items:center;z-index:30}
  .chip{padding:6px 10px;border:1px solid var(--border);background:var(--panel);border-radius:12px}
  .chip.on{outline:2px solid #5d62ff}
  .note{position:absolute;left:50%;top:14px;transform:translateX(-50%);padding:8px 12px;background:rgba(10,15,28,.8);border:1px dashed #274; color:#bfe; border-radius:12px}
  /* menu */
  nav.menu{position:fixed;top:56px;right:12px;width:280px;max-width:calc(100% - 24px);background:var(--panel-2);border:1px solid var(--border);border-radius:14px;display:none;flex-direction:column;z-index:60;box-shadow:0 10px 30px #0008}
  nav.menu.open{display:flex}
  nav.menu a{padding:12px 14px;border-bottom:1px solid var(--border);text-decoration:none;color:#dbe6ff}
  nav.menu a:last-child{border-bottom:none}
  /* full panels */
  .panel{position:fixed;inset:56px 0 0 0;background:linear-gradient(180deg,#0b1220,#0a1020);display:none;z-index:55}
  .panel.open{display:block}
  .panel .head{display:flex;justify-content:space-between;align-items:center;padding:12px 12px;border-bottom:1px solid var(--border);background:var(--panel)}
  .back{padding:6px 10px;border:1px solid var(--border);background:var(--panel-2);border-radius:10px}
  .grid{padding:12px;display:grid;grid-template-columns:repeat( auto-fill, minmax(140px,1fr) );gap:12px}
  .tile{border:1px solid var(--border);background:var(--panel);border-radius:12px;padding:10px}
  .rar{font-size:11px;padding:2px 6px;border-radius:10px;border:1px solid var(--border)}
  .BASIC{background:#0f1b2a}
  .RARE{background:#1a2d4a}
  .EPIC{background:#2a1a4a}
  .LEG{background:#4a2a1a}
  .SUP{background:#3d275a}
  .center{display:grid;place-items:center}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .big{padding:10px 14px;border:1px solid var(--border);background:var(--panel);border-radius:12px}
  .gain{color:var(--good)}
  .warn{color:#ffb86b}
  .full{width:100%}
  /* inventory / equip */
  .slotRow{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
  .slot{border:1px dashed var(--border);border-radius:10px;padding:8px;min-height:58px;text-align:center}
  .small{font-size:12px;opacity:.7}
  /* summon animation zone */
  .summonArea{padding:12px}
  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:720px){.cards{grid-template-columns:repeat(5,1fr)}}
  .cardDrop{border:1px solid var(--border);background:linear-gradient(180deg,#0e1530,#0a1020);border-radius:12px;padding:10px;animation:pop .2s ease-out;position:relative}
  @keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
  .shine{position:absolute;inset:-2px;border-radius:12px;background:conic-gradient(from 0deg,transparent,rgba(125,227,255,.25),transparent);filter:blur(8px);animation:spin 2s linear infinite}
  @keyframes spin{to{transform:rotate(1turn)}}
  /* debug */
  #debug{position:fixed;left:8px;bottom:8px;z-index:9999;max-width:90vw;padding:6px 8px;border:1px solid #334;border-radius:8px;background:#0b1220;color:#fbb;font:12px/1.2 monospace}
</style>
</head>
<body>

<header class="hud">
  <div class="brand">Dino<br/>Quest</div>
  <div class="badges">
    <div class="badge">Lvl <span id="lvl">1</span></div>
    <div class="badge j"><span class="i">ðŸª™</span><span id="gold">0</span></div>
    <div class="badge j"><span class="i">ðŸ’Ž</span><span id="gems">0</span></div>
    <button id="ham" class="ham" aria-label="menu" aria-expanded="false"><div></div></button>
  </div>
</header>

<!-- MENU -->
<nav id="menu" class="menu">
  <a href="#" data-tab="improve">AmÃ©liorations</a>
  <a href="#" data-tab="summon">Tirage</a>
  <a href="#" data-tab="bag">Inventaire</a>
  <a href="#" data-tab="dex">Classeur</a>
  <a href="#" data-tab="shop">Boutique</a>
  <a href="#" data-tab="promo">Code Promo</a>
  <a href="#" id="reset">RÃ©initialiser la sauvegarde</a>
</nav>

<!-- PANELS -->
<section id="panel-improve" class="panel">
  <div class="head"><strong>AmÃ©liorations</strong> <button class="back" data-close>Retour</button></div>
  <div class="grid" id="improveGrid"></div>
  <div class="center" style="padding:10px 12px;">
    <div class="warn small">Le coÃ»t augmente avec le niveau du dino. Ã€ partir du niv. 15 : +20ðŸ’Ž en plus de lâ€™or.</div>
  </div>
</section>

<section id="panel-summon" class="panel">
  <div class="head"><strong>Tirage</strong> <button class="back" data-close>Retour</button></div>
  <div class="center" style="padding:12px">
    <div class="actions">
      <button class="big" id="onePull">Tirage 1 (100ðŸ’Ž)</button>
      <button class="big" id="tenPull">Tirage 10 (1000ðŸ’Ž)</button>
    </div>
  </div>
  <div class="summonArea">
    <div id="summonDrops" class="cards"></div>
  </div>
</section>

<section id="panel-bag" class="panel">
  <div class="head"><strong>Inventaire (objets)</strong> <button class="back" data-close>Retour</button></div>
  <div class="grid" id="bagGrid"></div>
</section>

<section id="panel-dex" class="panel">
  <div class="head"><strong>Classeur</strong> <button class="back" data-close>Retour</button></div>
  <div class="grid" id="dexGrid"></div>
</section>

<section id="panel-shop" class="panel">
  <div class="head"><strong>Boutique</strong> <button class="back" data-close>Retour</button></div>
  <div class="center" style="padding:12px">
    <div class="actions">
      <button class="big" id="daily">Coffre quotidien (gratuit)</button>
      <button class="big" id="goldPack">+50 000ðŸª™ (2 000ðŸ’Ž)</button>
      <button class="big" id="gemPack">+2 000ðŸ’Ž (50 000ðŸª™)</button>
    </div>
  </div>
</section>

<section id="panel-promo" class="panel">
  <div class="head"><strong>Code Promo</strong> <button class="back" data-close>Retour</button></div>
  <div class="center" style="padding:16px">
    <input id="promo" placeholder="Entrez votre codeâ€¦" class="big" style="background:var(--panel);border:1px solid var(--border);border-radius:12px;color:#dbe6ff"/>
    <button id="applyPromo" class="big">Valider</button>
  </div>
  <div class="center small" style="opacity:.8">Astuce : <code>MEGA-START</code></div>
</section>

<!-- STAGE -->
<main class="stage">
  <div class="scene" id="scene">
    <!-- dÃ©cor gÃ©nÃ©rÃ© en JS -->
    <div class="note" id="msg">Combat auto â€” Boss toutes les 15 zones (+10ðŸ’Ž)</div>

    <!-- cartes -->
    <div class="card enemy" id="enemyCard">
      <h3 id="enemyName">Niv. 1 â€” LÃ©zard Sauvage</h3>
      <div class="line"><div id="enemyHp" class="hp"></div></div>
      <div class="stats" id="enemyStats">ATK 6 â€¢ DEF 2</div>
    </div>

    <div class="card ally" id="allyCard">
      <div class="allyRow" id="allyRow"></div>
    </div>

    <!-- sprites -->
    <img id="allySprite" class="sprite" alt="">
    <img id="enemySprite" class="enemySprite" alt="">
    <div id="fxLayer" class="fx"></div>
  </div>
</main>

<!-- SPEED -->
<div class="speed">
  <span class="chip small">Vitesse dâ€™attaque</span>
  <button class="chip on" data-speed="1">x1</button>
  <button class="chip" data-speed="2">x2</button>
  <button class="chip" data-speed="3">x3</button>
</div>

<script>
/* ---------------------- DATA ---------------------- */
const RARITIES = ["BASIC","RARE","EPIC","LEGENDARY","SUPREME"];
const POOL = [
  {id:"raptor", name:"Petit Raptor", emoji:"ðŸ¦•", rarity:"BASIC", hp:120, atk:8, def:2, spd:1.2},
  {id:"stego",  name:"Stego-Pique", emoji:"ðŸ¦–", rarity:"RARE",  hp:150, atk:10, def:4, spd:1.2},
  {id:"dilo",   name:"Dilo-Flash", emoji:"ðŸ¦Ž", rarity:"RARE",  hp:110, atk:12, def:3, spd:1.0},
  {id:"trike",  name:"Tri-Corne", emoji:"ðŸ¦", rarity:"EPIC",  hp:180, atk:12, def:7, spd:1.3},
  {id:"ptero",  name:"Ptero-Swift", emoji:"ðŸ¦…", rarity:"EPIC",  hp:120, atk:15, def:4, spd:0.9},
  {id:"rex",    name:"Rex Alpha", emoji:"ðŸ¦–", rarity:"LEGENDARY", hp:220, atk:22, def:10, spd:1.1},
  {id:"spino",  name:"Spino-Rage", emoji:"ðŸŠ", rarity:"LEGENDARY", hp:200, atk:24, def:8, spd:1.0},
  {id:"giga",   name:"Giga-Primus", emoji:"ðŸ‰", rarity:"SUPREME", hp:300, atk:32, def:12, spd:1.0},
];
const ITEM_POOL = [
  {id:"sword", name:"Griffe affÃ»tÃ©e", slot:"ATK",  bonus:{atk:+4},  rarity:"RARE"},
  {id:"shell", name:"Carapace",       slot:"DEF",  bonus:{def:+3},  rarity:"RARE"},
  {id:"heart", name:"CÅ“ur ancien",    slot:"HP",   bonus:{hp:+30},  rarity:"EPIC"},
  {id:"wing",  name:"Aile lÃ©gÃ¨re",    slot:"SPD",  bonus:{spd:-0.1},rarity:"EPIC"},
  {id:"fang",  name:"Croc royal",     slot:"ATK",  bonus:{atk:+8},  rarity:"LEGENDARY"},
  {id:"scale", name:"Ã‰caille divine", slot:"DEF",  bonus:{def:+6},  rarity:"LEGENDARY"},
  {id:"orb",   name:"Orbe azur",      slot:"HP",   bonus:{hp:+60},  rarity:"SUPREME"},
];
const DROP_RATES = { BASIC:55, RARE:25, EPIC:12, LEGENDARY:7, SUPREME:1 }; // pour tirage dino
const ENEMY_NAMES = ["LÃ©zard Sauvage","Raptor Fielleux","Carcajou Rugissant","RÃ´deur Fossile"];
/* ---------------------- STATE ---------------------- */
let S = JSON.parse(localStorage.getItem("dinoq_save")||"null") || {
  lvl:1, gold:0, gems:0, speed:1,
  team:[], collection:[], bag:[], // bag: objets
  player:{stats:{kills:0, damageDealt:0, damageTaken:0, goldEarned:0, gemsEarned:0}}
};
function save(){ localStorage.setItem("dinoq_save", JSON.stringify(S)); }
/* ---------------------- UTIL ---------------------- */
const $ = s=>document.querySelector(s);
function rnd(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function pickByRate(map){
  const total = Object.values(map).reduce((a,b)=>a+b,0);
  let r = Math.random()*total;
  for(const [k,v] of Object.entries(map)){ if((r-=v)<=0) return k; }
  return "BASIC";
}
function baseOf(id){ return POOL.find(d=>d.id===id); }
function makeDino(base){
  return { uid:crypto.randomUUID(), id:base.id, name:base.name, emoji:base.emoji, rarity:base.rarity,
    lvl:1, hp:base.hp, atk:base.atk, def:base.def, spd:base.spd, cur:base.hp,
    equip:{HP:null,ATK:null,DEF:null,SPD:null} };
}
function cloneDino(base){ return makeDino(baseOf(base.id||base)); }
function applyEquip(d){
  let hp=d.hp, atk=d.atk, def=d.def, spd=d.spd;
  for(const k of ["HP","ATK","DEF","SPD"]){
    const it=d.equip[k]; if(!it) continue;
    if(it.bonus.hp) hp+=it.bonus.hp;
    if(it.bonus.atk) atk+=it.bonus.atk;
    if(it.bonus.def) def+=it.bonus.def;
    if(it.bonus.spd) spd+=it.bonus.spd;
  }
  return {hp,atk,def,spd};
}
/* ---------------------- INIT (one-time) ---------------------- */
if(!S.collection.length){
  S.collection = [ makeDino(POOL[0]) ];
  S.team = S.collection.slice(0,1);
  save();
}
/* ---------------------- UI HEAD ---------------------- */
function uiHead(){ $("#lvl").textContent=S.lvl; $("#gold").textContent=S.gold.toLocaleString(); $("#gems").textContent=S.gems.toLocaleString(); }
/* ---------------------- DECOR ---------------------- */
function drawDecor(){
  const sc = $("#scene");
  sc.querySelectorAll(".deco").forEach(e=>e.remove());
  // quelques arbres + lave selon zone
  for(let i=0;i<6;i++){
    const t=document.createElement("div"); t.className="deco tree";
    t.style.left = (10 + i*15 + rnd(-5,5))+"%";
    t.style.top  = (70 + rnd(-8,8))+"%";
    sc.appendChild(t);
  }
  if( Math.floor(S.lvl/5)%2===1 ){
    const l=document.createElement("div"); l.className="deco lava";
    l.style.left="50%"; l.style.bottom="10%"; l.style.transform="translateX(-50%)";
    sc.appendChild(l);
  }
}
/* ---------------------- TEAM RENDER ---------------------- */
function renderTeam(){
  const row=$("#allyRow"); row.innerHTML="";
  const team=S.team.slice(0,5);
  team.forEach((d,i)=>{
    const stats=applyEquip(d);
    if(d.cur>stats.hp) d.cur=stats.hp;
    const wrap=document.createElement("div"); wrap.className="allyMini tile"; wrap.style.width="160px";
    wrap.innerHTML=`
      <h4>${d.emoji} ${d.name} <span class="rar ${shortR(d.rarity)}">${d.rarity}</span></h4>
      <div class="line"><div class="hp" style="width:${(d.cur/stats.hp*100).toFixed(1)}%"></div></div>
      <div class="small">PV ${d.cur}/${stats.hp} â€¢ ATK ${stats.atk} â€¢ DEF ${stats.def} â€¢ VIT ${stats.spd.toFixed(1)}s</div>
    `;
    wrap.onclick=()=>openDinoDetail(d);
    row.appendChild(wrap);
  });
}
function shortR(r){ return ({BASIC:"BASIC",RARE:"RARE",EPIC:"EPIC",LEG:"LEG",LEGENDARY:"LEG",SUPREME:"SUP"})[r]||"BASIC"; }
/* ---------------------- ENEMY ---------------------- */
let EN = { name:"", hp:100, cur:100, atk:8, def:2, emoji:"ðŸ¦Ž" };
function newEnemy(){
  const count = Math.min(4, 1 + Math.floor(S.lvl/6)); // jusqu'Ã  4
  const baseAtk = 6 + S.lvl*2, baseDef = 2 + Math.floor(S.lvl*0.6), baseHp = 80 + S.lvl*25;
  EN = {name:`Niv. ${S.lvl} â€” ${ENEMY_NAMES[rnd(0,ENEMY_NAMES.length-1)]}`, hp:baseHp*count, cur:baseHp*count, atk:baseAtk, def:baseDef, emoji:"ðŸ¦Ž"};
  $("#enemyName").textContent=EN.name;
  $("#enemyStats").textContent=`ATK ${EN.atk} â€¢ DEF ${EN.def}`;
  setEnemyHP();
  $("#enemySprite").src = emojiToData(EN.emoji);
}
function setEnemyHP(){ $("#enemyHp").style.width = Math.max(0,(EN.cur/EN.hp)*100)+"%"; }
/* ---------------------- SPRITES (emoji -> dataURI) ---------------------- */
function emojiToData(emo){
  const c=document.createElement("canvas"); c.width=128; c.height=128;
  const ctx=c.getContext("2d"); ctx.font="96px Apple Color Emoji, Noto Color Emoji, Segoe UI Emoji";
  ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(emo,64,74);
  return c.toDataURL();
}
/* ---------------------- COMBAT LOOP ---------------------- */
let last=0;
function loop(t){
  const dt = (t-last)/1000; last=t;
  // autos attaques des alliÃ©s
  for(const d of S.team){
    if(!d._cd) d._cd=0;
    d._cd -= dt*S.speed;
    if(d._cd<=0){
      d._cd = applyEquip(d).spd;
      // dommage = atk - def/2
      const st=applyEquip(d);
      const dmg = Math.max(1, Math.round(st.atk - EN.def*0.35));
      EN.cur = Math.max(0, EN.cur - dmg);
      S.player.stats.damageDealt += dmg;
      flashHit("#enemySprite");
      setEnemyHP();
      if(EN.cur<=0){ win(); break; }
    }
  }
  // riposte globale de lâ€™ennemi (tape la team entiÃ¨re)
  if(!EN._cd) EN._cd=0;
  EN._cd -= dt*S.speed;
  if(EN._cd<=0){
    EN._cd = 1.4;
    S.team.forEach(d=>{
      const st=applyEquip(d);
      const dmg = Math.max(1, Math.round(EN.atk - st.def*0.4));
      d.cur = Math.max(0, d.cur - dmg);
      S.player.stats.damageTaken += dmg;
      if(d.cur<=0) d.cur=0;
    });
    renderTeam();
    shake("#allyCard");
    // dÃ©faite si tous KO â†’ on recommence la zone
    if( S.team.every(d=>d.cur<=0) ){
      message("Ton Ã©quipe a Ã©tÃ© vaincue. On retente !",2000);
      S.team.forEach(d=>d.cur=applyEquip(d).hp);
      save();
    }
  }
  requestAnimationFrame(loop);
}
function flashHit(sel){
  const el=$(sel); if(!el) return;
  el.style.animation="hit .18s";
  setTimeout(()=>el.style.animation="", 180);
}
function shake(sel){
  const el=$(sel); if(!el) return; el.style.animation="hit .25s"; setTimeout(()=>el.style.animation="",250);
}
function win(){
  S.player.stats.kills++;
  const goldGain = 10 + 6*S.lvl;
  S.gold += goldGain; S.player.stats.goldEarned += goldGain;
  if(S.lvl%15===0){ S.gems+=10; S.player.stats.gemsEarned+=10; message("Boss vaincu ! +10ðŸ’Ž",1600); }
  S.lvl++; uiHead(); save(); newEnemy(); drawDecor(); message(`Ennemi vaincu ! +${goldGain}ðŸª™`,1200);
}
/* ---------------------- PANELS / MENU ---------------------- */
function openPanel(name){ document.querySelectorAll(".panel").forEach(p=>p.classList.remove("open")); $("#panel-"+name).classList.add("open"); $("#menu").classList.remove("open"); $("#ham").setAttribute("aria-expanded","false"); }
function closePanels(){ document.querySelectorAll(".panel").forEach(p=>p.classList.remove("open")); }
function message(t,ms=1200){ $("#msg").textContent=t; $("#msg").style.opacity=1; setTimeout(()=>{$("#msg").style.opacity=.75}, ms); }
/* ---------------------- IMPROVE / EQUIP ---------------------- */
function renderImprove(){
  const g=$("#improveGrid"); g.innerHTML="";
  S.collection.forEach(d=>{
    const st=applyEquip(d);
    const cost = 500 + (d.lvl-1)*120;
    const extraGem = d.lvl>=15 ? 20 : 0;
    const tile=document.createElement("div"); tile.className="tile";
    tile.innerHTML=`
      <div class="actions" style="justify-content:space-between;">
        <div><strong>${d.emoji} ${d.name}</strong><div class="small">Niv. ${d.lvl} â€¢ ${d.rarity}</div></div>
        <button class="big" data-up="${d.uid}">AmÃ©liorer (${cost}ðŸª™${extraGem?` + ${extraGem}ðŸ’Ž`:""})</button>
      </div>
      <div class="slotRow">
        ${["HP","ATK","DEF","SPD"].map(k=>{
          const it=d.equip[k];
          return `<div class="slot" data-slot="${k}" data-id="${d.uid}">
            <div class="small">${k}</div>
            ${it? `<div>${it.name}</div><div class="small gain">${Object.entries(it.bonus).map(([k,v])=>`${k.toUpperCase()} ${v>0?`+${v}`:v}`).join(" ")}</div>`:"<div class='small' style='opacity:.6'>vide</div>"}
          </div>`;
        }).join("")}
      </div>
    `;
    g.appendChild(tile);
  });
  // actions
  g.querySelectorAll("[data-up]").forEach(btn=>{
    btn.onclick=()=>{
      const d = S.collection.find(x=>x.uid===btn.dataset.up);
      const cost = 500 + (d.lvl-1)*120;
      const extraGem = d.lvl>=15 ? 20 : 0;
      if(S.gold<cost || S.gems<extraGem){ message("Pas assez de ressources",1200); return; }
      S.gold-=cost; S.gems-=extraGem;
      d.lvl++; d.hp+=20; d.atk+=2; d.def+=1; d.cur=d.hp;
      uiHead(); renderImprove(); renderTeam(); save();
    };
  });
  // Ã©quiper depuis lâ€™inventaire
  g.querySelectorAll(".slot").forEach(slot=>{
    slot.onclick=()=>{
      const d = S.collection.find(x=>x.uid===slot.dataset.id);
      const slotK = slot.dataset.slot;
      // pick premier item compatible
      const idx = S.bag.findIndex(it=>it.slot===slotK);
      if(idx===-1){ message("Aucun objet compatible dans lâ€™inventaire",1400); return; }
      const it = S.bag.splice(idx,1)[0];
      if(d.equip[slotK]) S.bag.push(d.equip[slotK]); // remets lâ€™ancien dans le sac
      d.equip[slotK]=it; renderImprove(); renderTeam(); renderBag(); save();
    };
  });
}
function openDinoDetail(d){ openPanel("improve"); setTimeout(()=>{document.querySelector(`[data-up='${d.uid}']`)?.scrollIntoView({block:"center"})},50); }
/* ---------------------- INVENTAIRE ---------------------- */
function renderBag(){
  const g=$("#bagGrid"); g.innerHTML="";
  if(!S.bag.length){ g.innerHTML=`<div class="tile center full small" style="grid-column:1/-1;opacity:.7">Aucun objet. Ouvre la Boutique ou fais des tirages de coffres.</div>`; return; }
  S.bag.forEach((it,i)=>{
    const t=document.createElement("div"); t.className="tile";
    t.innerHTML=`<div><strong>${it.name}</strong> <span class="rar ${shortR(it.rarity)}">${it.rarity}</span></div>
    <div class="small">Slot ${it.slot}</div>
    <div class="gain small">${Object.entries(it.bonus).map(([k,v])=>`${k.toUpperCase()} ${v>0?`+${v}`:v}`).join(" ")}</div>`;
    g.appendChild(t);
  });
}
/* ---------------------- CLASSEUR ---------------------- */
function renderDex(){
  const g=$("#dexGrid"); g.innerHTML="";
  const have=new Set(S.collection.map(d=>d.id));
  POOL.forEach(p=>{
    const own=have.has(p.id);
    const t=document.createElement("div"); t.className="tile";
    t.style.opacity=own?1:.5;
    t.innerHTML=`<div><strong>${p.emoji} ${p.name}</strong> <span class="rar ${shortR(p.rarity)}">${p.rarity}</span></div>
    <div class="small">${own? "DÃ©bloquÃ©":"Non obtenu"}</div>`;
    g.appendChild(t);
  });
}
/* ---------------------- TIRAGE ---------------------- */
function pull(n=1){
  if(n===1 && S.gems<100) return message("Pas assez de ðŸ’Ž",1200);
  if(n===10 && S.gems<1000) return message("Pas assez de ðŸ’Ž",1200);
  S.gems -= (n===1?100:1000); uiHead(); save();
  const out=[];
  for(let i=0;i<n;i++){
    const rar = pickByRate(DROP_RATES);
    // 70% dino / 30% item
    if(Math.random()<0.7){
      // pick dino de cette raretÃ©
      const choices = POOL.filter(p=>p.rarity===rar);
      const base = choices[rnd(0,choices.length-1)];
      const d = makeDino(base);
      S.collection.push(d);
      if(S.team.length<5) S.team.push(d);
      out.push({type:"dino", item:d});
    }else{
      const choices = ITEM_POOL.filter(p=>p.rarity===rar || rar==="BASIC");
      const it = JSON.parse(JSON.stringify(choices[rnd(0,choices.length-1)]));
      S.bag.push(it); out.push({type:"item", item:it});
    }
  }
  renderTeam(); renderBag(); renderDex(); save();
  // animation dâ€™affichage
  const zone=$("#summonDrops"); zone.innerHTML="";
  out.forEach(r=>{
    const c=document.createElement("div"); c.className="cardDrop";
    const shine=document.createElement("div"); shine.className="shine"; c.appendChild(shine);
    if(r.type==="dino"){
      c.innerHTML += `<div style="font-size:22px">${r.item.emoji} ${r.item.name}</div>
      <div class="small">RaretÃ©: <b>${r.item.rarity}</b></div>`;
    }else{
      c.innerHTML += `<div style="font-size:16px">${r.item.name}</div>
      <div class="small">Objet â€¢ ${r.item.slot}</div>
      <div class="gain small">${Object.entries(r.item.bonus).map(([k,v])=>`${k.toUpperCase()} ${v>0?`+${v}`:v}`).join(" ")}</div>`;
    }
    zone.appendChild(c);
  });
}
/* ---------------------- BOUTIQUE ---------------------- */
function canClaimDaily(){
  const last=+(localStorage.getItem("dinoq_daily")||0);
  return Date.now() - last > 24*3600*1000;
}
function claimDaily(){
  if(!canClaimDaily()){ message("DÃ©jÃ  pris aujourdâ€™hui",1200); return; }
  S.gold+=1000; S.gems+=10; uiHead(); save();
  localStorage.setItem("dinoq_daily", Date.now()+"");
  message("Coffre quotidien : +1000ðŸª™ +10ðŸ’Ž",1500);
}
/* ---------------------- HOOKS & CONTROLS ---------------------- */
function hooks(){
  // hamburger
  const ham=$("#ham"), menu=$("#menu");
  ham.onclick=(e)=>{ e.stopPropagation(); menu.classList.toggle("open"); ham.setAttribute("aria-expanded", menu.classList.contains("open")); };
  document.addEventListener("click",()=>menu.classList.remove("open"));

  // tabs open
  menu.querySelectorAll("[data-tab]").forEach(a=>{
    a.onclick=(e)=>{ e.preventDefault(); openPanel(a.dataset.tab);
      if(a.dataset.tab==="improve") renderImprove();
      if(a.dataset.tab==="bag") renderBag();
      if(a.dataset.tab==="dex") renderDex();
    };
  });
  // close buttons
  document.querySelectorAll("[data-close]").forEach(b=> b.onclick=()=>closePanels() );

  // speed
  document.querySelectorAll("[data-speed]").forEach(b=>{
    b.onclick=()=>{ document.querySelectorAll(".chip").forEach(x=>x.classList.remove("on")); b.classList.add("on"); S.speed=+b.dataset.speed; save(); }
  });

  // summon
  $("#onePull").onclick=()=>pull(1);
  $("#tenPull").onclick=()=>pull(10);

  // shop
  $("#daily").onclick=()=>claimDaily();
  $("#goldPack").onclick=()=>{ if(S.gems<2000) return message("Pas assez de ðŸ’Ž",1200); S.gems-=2000; S.gold+=50000; uiHead(); save(); message("+50 000ðŸª™",900); };
  $("#gemPack").onclick=()=>{ if(S.gold<50000) return message("Pas assez dâ€™or",1200); S.gold-=50000; S.gems+=2000; uiHead(); save(); message("+2 000ðŸ’Ž",900); };

  // promo
  $("#applyPromo").onclick=()=>{
    const c=$("#promo").value.trim().toUpperCase();
    if(c==="MEGA-START"){ S.gold+=200000; S.gems+=50000; uiHead(); save(); message("Bonus appliquÃ© !",1200); }
    else message("Code invalide",1000);
  };

  // reset
  $("#reset").onclick=(e)=>{ e.preventDefault();
    if(confirm("Effacer la sauvegarde ?")){ localStorage.removeItem("dinoq_save"); location.reload(); }
  });
}
/* ---------------------- START ---------------------- */
function start(){
  uiHead();
  drawDecor();
  // Ã©quipe de base (max 5)
  S.team = S.team.slice(0,5);
  renderTeam();
  // sprites init
  $("#allySprite").src = emojiToData((S.team[0]||S.collection[0]).emoji);
  $("#enemySprite").src = emojiToData("ðŸ¦Ž");
  newEnemy();
  hooks();
  requestAnimationFrame(t=>{ last=t; loop(t); });
}
document.addEventListener("DOMContentLoaded", start);
</script>

<!-- DEBUG OVERLAY (garde-le pendant quâ€™on itÃ¨re ; tu pourras le supprimer aprÃ¨s) -->
<script>
(function(){
  const box = document.createElement('div');
  box.id='debug'; box.textContent='debug: ok'; document.body.appendChild(box);
  window.addEventListener('error', e=>{
    box.textContent = 'JS error â†’ ' + (e.message||'') + ' @ ' + (e.filename||'') + ':' + (e.lineno||'');
  });
  window.addEventListener('unhandledrejection', e=>{
    box.textContent = 'Promise error â†’ ' + (e.reason && (e.reason.message||e.reason));
  });
  const need = ['scene','allyRow','enemyCard','ham','menu'];
  const missing = need.filter(id=>!document.getElementById(id));
  if(missing.length) box.textContent = 'Manque Ã©lÃ©ments DOM: '+missing.join(', ');
})();
</script>

</body>
</html>
