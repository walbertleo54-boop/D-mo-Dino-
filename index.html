<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dino Quest</title>
<style>
:root{
  --bg:#0b0f14;--panel:#121926;--panel2:#0f1520;--txt:#d8e1ff;
  --gold:#f2c94c;--gems:#56ccf2;--hp:#22d3ee;--ring:#0c1320;--accent:#1f2937
}
*{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 600px at 50% 0%,#0f1624,#0b0f14 60%);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a,button{cursor:pointer}
.hud{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;background:linear-gradient(180deg,#0f1624,#0e1420);border-bottom:1px solid #162238}
.brand{font-weight:800;letter-spacing:.5px}
.badge{display:flex;gap:10px;align-items:center}
.b{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #25324a;border-radius:10px;background:var(--panel)}
.b .ico{opacity:.9}
.ham{width:38px;height:38px;border-radius:10px;border:1px solid #25324a;background:var(--panel);color:var(--txt);font-size:20px}
.wrap{max-width:980px;margin:0 auto;padding:14px}

.stage{position:relative;aspect-ratio:16/9;max-width:980px;margin:12px auto;border:1px solid #1b2740;border-radius:14px;overflow:hidden;background:linear-gradient(#06121c,#0a1622 60%,#0b0f14)}
.scene{position:absolute;inset:0;padding:16px}
.speed{position:absolute;left:14px;top:14px;display:flex;gap:8px}
.speed button{padding:6px 12px;border:1px solid #25324a;border-radius:10px;background:var(--panel);color:var(--txt)}
.enemyCard,.allyCard{position:absolute;min-width:220px;border:1px solid #25324a;border-radius:12px;background:var(--panel);padding:10px}
.enemyCard{right:16px;top:40px}
.allyCard{left:16px;bottom:28px}
.name{font-weight:800;margin-bottom:6px}
.stat{opacity:.8;font-size:13px}
.hpbar{height:10px;background:#0a1220;border:1px solid #20304d;border-radius:8px;overflow:hidden;margin-top:8px}
.hpbar>i{display:block;height:100%;background:linear-gradient(90deg,#10b7d8,#22d3ee)}

.msg{margin:10px auto 0;border:1px dashed #25324a;border-radius:10px;background:var(--panel2);padding:10px;text-align:center;max-width:720px}

/* Menu latÃ©ral */
.menu{position:fixed;top:0;right:-320px;width:300px;height:100dvh;background:var(--panel);border-left:1px solid #23324c;padding:16px;display:flex;flex-direction:column;gap:8px;z-index:60;transition:right .18s ease}
.menu.open{right:0}
.menu a{display:block;padding:12px;border:1px solid #25324a;border-radius:10px;background:var(--panel2);color:var(--txt);text-decoration:none}

/* Panneaux (sheets) */
.sheet{position:fixed;inset:auto 0 0 0;max-height:70dvh;background:var(--panel);border-top:1px solid #23324c;border-radius:16px 16px 0 0;transform:translateY(110%);transition:transform .22s ease;z-index:55}
.sheet.open{transform:translateY(0)}
.sheet .inner{padding:14px;max-width:980px;margin:0 auto}
.sheet h3{margin:6px 0 10px}
.grid6{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
.card{border:1px solid #25324a;background:var(--panel2);border-radius:10px;padding:8px;text-align:center}
.r{font-size:11px;opacity:.8}
.tag{display:inline-block;padding:3px 8px;border:1px solid #2a3a58;border-radius:8px;margin:4px 0;background:#0e1626}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #2a3a58;border-radius:10px;background:#132039;color:var(--txt);text-decoration:none}
.btn.gold .ico{color:var(--gold)} .btn.gem .ico{color:var(--gems)}
.center{text-align:center}
.small{font-size:12px;opacity:.8}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.input{padding:8px 10px;border:1px solid #2a3a58;border-radius:10px;background:#101a2e;color:var(--txt)}

/* RaretÃ©s couleurs */
.badgeRare{background:#20315a;border-color:#3757a6}
.badgeEpic{background:#341b4e;border-color:#6f3bb8}
.badgeLegend{background:#2f220c;border-color:#b8892a}
.badgeSupreme{background:#152f2a;border-color:#33d1a5}

/* Helpers inventaire */
.slot{border:1px dashed #2a3a58;border-radius:10px;padding:8px;min-height:74px;display:grid;place-items:center}
</style>
</head>
<body>
  <!-- HUD -->
  <div class="hud">
    <div class="brand">Dino Quest</div>
    <div class="badge">
      <div class="b"><span class="ico">Lvl</span> <span id="lvl">1</span></div>
      <div class="b"><span class="ico">ðŸª™</span> <span id="gold">0</span></div>
      <div class="b"><span class="ico">ðŸ’Ž</span> <span id="gems">0</span></div>
      <button id="ham" class="ham" aria-label="menu" aria-expanded="false">â˜°</button>
    </div>
  </div>

  <!-- Menu -->
  <nav id="menu" class="menu">
    <a href="#" data-tab="improve">AmÃ©liorations</a>
    <a href="#" data-tab="summon">Tirage</a>
    <a href="#" data-tab="bag">Inventaire</a>
    <a href="#" data-tab="dex">Classeur</a>
    <a href="#" data-tab="equip">Ã‰quipement</a>
    <a href="#" data-tab="promo">Code Promo</a>
    <a href="#" data-tab="profile">Profil</a>
    <a href="#" data-tab="friends">Amis</a>
    <a href="#" data-tab="rank">Classement</a>
    <a href="#" id="reset">Reset sauvegarde</a>
  </nav>

  <!-- ScÃ¨ne de combat -->
  <div class="stage">
    <div class="scene">
      <div class="speed">
        <button data-sp="1">x1</button>
        <button data-sp="2">x2</button>
        <button data-sp="3">x3</button>
      </div>
      <div class="enemyCard" id="enemyBox">
        <div class="name" id="enemyName">Niv. 1 â€” LÃ©zard Sauvage</div>
        <div class="hpbar"><i id="enemyHP" style="width:100%"></i></div>
        <div class="stat"><span id="enemyStats">ATK 0  DEF 0</span></div>
      </div>
      <div class="allyCard" id="allyBox">
        <div style="font-size:40px" id="allyEmoji">ðŸ¦•</div>
        <div class="name" id="allyName">Petit Raptor â€” BASIC</div>
        <div class="hpbar"><i id="allyHP" style="width:100%"></i></div>
        <div class="stat"><span id="allyStats">PV 120  â€¢ ATK 8 â€¢ DEF 2 â€¢ VIT 1.2s</span></div>
      </div>
      <div class="msg" id="msg">Combat auto â€” boss tous les 10 niveaux (+10 gemmes)</div>
    </div>
  </div>

  <!-- SHEETS -->
  <!-- AmÃ©liorations -->
  <div id="sheet-improve" class="sheet"><div class="inner">
    <h3>AmÃ©liorations</h3>
    <div class="row">
      <button class="btn gold" data-up="hp"><span class="ico">ðŸª™</span> +20 PV (500)</button>
      <button class="btn gold" data-up="atk"><span class="ico">ðŸª™</span> +2 ATK (500)</button>
      <button class="btn gold" data-up="def"><span class="ico">ðŸª™</span> +1 DEF (500)</button>
    </div>
  </div></div>

  <!-- Tirage -->
  <div id="sheet-summon" class="sheet"><div class="inner">
    <h3>Tirage</h3>
    <div class="row">
      <button class="btn gem" id="pull1"><span class="ico">ðŸ’Ž</span> Tirage x1 (100)</button>
      <button class="btn gem" id="pull10"><span class="ico">ðŸ’Ž</span> Tirage x10 (1000)</button>
    </div>
    <h4 style="margin:12px 0 6px">Coffres (Or)</h4>
    <div class="row">
      <button class="btn gold" data-chest="basic"><span class="ico">ðŸª™</span> Basic (1 000)</button>
      <button class="btn gold" data-chest="rare"><span class="ico">ðŸª™</span> Rare (5 000)</button>
      <button class="btn gold" data-chest="supreme"><span class="ico">ðŸª™</span> SuprÃªme (15 000)</button>
    </div>
    <div id="summonResult" class="row" style="margin-top:12px"></div>
  </div></div>

  <!-- Inventaire -->
  <div id="sheet-bag" class="sheet"><div class="inner">
    <h3>Inventaire (6 par ligne)</h3>
    <div id="bag" class="grid6"></div>
  </div></div>

  <!-- Classeur -->
  <div id="sheet-dex" class="sheet"><div class="inner">
    <h3>Classeur</h3>
    <div id="dex" class="grid6"></div>
  </div></div>

  <!-- Ã‰quipement -->
  <div id="sheet-equip" class="sheet"><div class="inner">
    <h3>Ã‰quipement â€” sÃ©lectionner un dinosaure</h3>
    <div id="equipTeam" class="row" style="margin-bottom:10px"></div>
    <div class="grid6">
      <div>
        <div class="tag">Arme</div>
        <div id="slot-weapon" class="slot">vide</div>
      </div>
      <div>
        <div class="tag">Armure</div>
        <div id="slot-armor" class="slot">vide</div>
      </div>
      <div>
        <div class="tag">Amulette</div>
        <div id="slot-amulet" class="slot">vide</div>
      </div>
    </div>
  </div></div>

  <!-- Code promo -->
  <div id="sheet-promo" class="sheet"><div class="inner">
    <h3>Code Promo</h3>
    <div class="row">
      <input id="promoInput" class="input" placeholder="Entrez un codeâ€¦">
      <button class="btn" id="applyPromo">Valider</button>
    </div>
    <p class="small">Astuce: <b>TESTDINO</b> â†’ 200 000 or + 50 000 gemmes</p>
  </div></div>

  <!-- Profil -->
  <div id="sheet-profile" class="sheet"><div class="inner">
    <h3>Profil</h3>
    <div class="row" style="margin:8px 0 14px">
      <label>Pseudo :</label>
      <input id="profileName" class="input" style="min-width:220px" placeholder="Ton pseudo">
      <button class="btn" id="saveProfile">Sauvegarder</button>
    </div>
    <div class="grid6" id="profileStats"></div>
    <h4 style="margin:16px 0 8px">Ã‰quipe actuelle</h4>
    <div class="grid6" id="profileTeam"></div>
    <p class="small" id="profileId"></p>
  </div></div>

  <!-- Amis -->
  <div id="sheet-friends" class="sheet"><div class="inner">
    <h3>Amis</h3>
    <div class="row" style="margin:8px 0 14px">
      <input id="friendId" class="input" placeholder="ID ami Ã  ajouter (ex: DQ-AB12-CD34)">
      <button class="btn" id="addFriendBtn">Ajouter</button>
    </div>
    <div id="friendsList" class="grid6"></div>
  </div></div>

  <!-- Classement -->
  <div id="sheet-rank" class="sheet"><div class="inner">
    <h3>Classement (local)</h3>
    <p class="small">Version locale pour test. PrÃªt Ã  brancher en ligne plus tard.</p>
    <div id="rankList" class="grid6"></div>
  </div></div>

<script>
/* ======= Ã‰TAT ======= */
const S = JSON.parse(localStorage.getItem("dq_save")||"{}");
S.lvl ??= 1; S.gold ??= 0; S.gems ??= 0; S.speed ??= 1;
S.collection ??= [];           // tous les dinos obtenus
S.team ??= [];                 // Ã©quipe active (max 5)
S.inv ??= [];                  // inventaire items
S.equip ??= { weapon:null, armor:null, amulet:null };
S.player ??= { id:null, name:"", stats:{kills:0,goldEarned:0,gemsEarned:0}, friends:[] };
if(!S.player.id) S.player.id = makeId();

function save(){ localStorage.setItem("dq_save", JSON.stringify(S)); }

/* ======= DATA ======= */
const RAR = ["BASIC","RARE","EPIC","LEGEND","SUPREME"];
const POOL = [
  { key:"raptor", name:"Petit Raptor", emoji:"ðŸ¦•", rarity:"BASIC",  hp:120, atk:8, def:2, spd:1.2 },
  { key:"trike",  name:"Tricera",     emoji:"ðŸ¦–", rarity:"RARE",   hp:180, atk:10, def:4, spd:1.2 },
  { key:"stego",  name:"Stego",       emoji:"ðŸ¦•", rarity:"EPIC",   hp:220, atk:12, def:6, spd:1.1 },
  { key:"rex",    name:"T-Rex",       emoji:"ðŸ¦–", rarity:"LEGEND", hp:260, atk:18, def:6, spd:1.0 },
  { key:"aero",   name:"AÃ©ro",        emoji:"ðŸ¦•", rarity:"SUPREME",hp:300, atk:24, def:8, spd:0.9 },
];

const CHESTS = {
  basic : {cost:1000,  table:[{t:"weapon",n:"Griffe Ã©brÃ©chÃ©e",atk:2,r:"BASIC"},{t:"armor",n:"Peau tannÃ©",def:1,r:"BASIC"},{t:"amulet",n:"Perle terne",hp:10,r:"BASIC"}]},
  rare  : {cost:5000,  table:[{t:"weapon",n:"Dard poli",atk:4,r:"RARE"},{t:"armor",n:"Cuir Ã©pais",def:2,r:"RARE"},{t:"amulet",n:"Perle azure",hp:25,r:"RARE"}]},
  supreme:{cost:15000, table:[{t:"weapon",n:"Crocs royaux",atk:8,r:"LEGEND"},{t:"armor",n:"Ã‰caille drake",def:4,r:"LEGEND"},{t:"amulet",n:"CÅ“ur ancien",hp:50,r:"LEGEND"}]}
};

function cloneD(d){ return JSON.parse(JSON.stringify(d)); }
function rollDino(){
  // taux de drop (10 dinos dÃ©finis au besoin) â€” simple pour dÃ©mo
  const r = Math.random();
  let pool = POOL.filter(d=>d.rarity==="BASIC");
  if(r<0.02) pool = POOL.filter(d=>d.rarity==="SUPREME");
  else if(r<0.08) pool = POOL.filter(d=>d.rarity==="LEGEND");
  else if(r<0.22) pool = POOL.filter(d=>d.rarity==="EPIC");
  else if(r<0.45) pool = POOL.filter(d=>d.rarity==="RARE");
  return cloneD(pool[Math.floor(Math.random()*pool.length)]);
}

/* ======= COMBAT ======= */
let enemy=null, ally=null, ehp=1, ahp=1;
function setWorld(lvl){
  const base = 60 + (lvl-1)*10;
  enemy = { name: (lvl%10===0?"Boss ":"")+"Niv. "+lvl+" â€” LÃ©zard Sauvage", atk: 6+lvl, def: 2+Math.floor(lvl/3), hp: base+lvl*8, emoji:"ðŸ¦Ž" };
  ehp = enemy.hp; renderEnemy();
}
function newEnemy(){ setWorld(S.lvl); }
function useTeam(){
  if(!S.team.length) S.team[0] = cloneD(POOL[0]);
  ally = S.team[0];
  ahp = ally.hp + (S.equip.amulet?.hp||0);
  renderAlly();
}

function tick(dt){
  const mult = S.speed;
  // Ally attaque
  if(Math.random() < dt/(ally.spd||1.2)*mult){
    const dmg = Math.max(1,(ally.atk+(S.equip.weapon?.atk||0)) - enemy.def);
    ehp -= dmg;
  }
  // Ennemi attaque
  if(Math.random() < dt/1.4*mult){
    const dmg = Math.max(1,(enemy.atk) - (ally.def+(S.equip.armor?.def||0)));
    ahp -= dmg;
  }
  // checks
  if(ehp<=0){
    S.player.stats.kills++; S.gold += 10+S.lvl*2; S.player.stats.goldEarned += 10+S.lvl*2;
    S.lvl++;
    if(S.lvl%10===0){ S.gems += 10; S.player.stats.gemsEarned += 10; msg("Boss vaincu ! +10 ðŸ’Ž"); }
    newEnemy(); useTeam(); save(); ui();
  }else if(ahp<=0){
    // dÃ©faite â†’ recommence le mÃªme niveau
    msg("DÃ©faiteâ€¦ on recommence le niveau !");
    useTeam(); save(); ui();
  }
  renderHP();
  requestAnimationFrame(tick);
}

/* ======= UI ======= */
function byId(id){ return document.getElementById(id); }
function ui(){
  byId("lvl").textContent = S.lvl;
  byId("gold").textContent = S.gold;
  byId("gems").textContent = S.gems;
}
function renderEnemy(){
  byId("enemyName").textContent = enemy.name;
  byId("enemyStats").textContent = `ATK ${enemy.atk}  DEF ${enemy.def}`;
  ehp = Math.max(1,ehp);
  renderHP();
}
function renderAlly(){
  byId("allyEmoji").textContent = ally.emoji||"ðŸ¦•";
  byId("allyName").textContent = `${ally.name} â€” ${ally.rarity}`;
  byId("allyStats").textContent = `PV ${ally.hp+(S.equip.amulet?.hp||0)} â€¢ ATK ${ally.atk+(S.equip.weapon?.atk||0)} â€¢ DEF ${ally.def+(S.equip.armor?.def||0)} â€¢ VIT ${ally.spd||1.2}s`;
  ahp = Math.max(1,ahp);
  renderHP();
}
function renderHP(){
  byId("enemyHP").style.width = Math.max(0,ehp/enemy.hp*100)+"%";
  byId("allyHP").style.width  = Math.max(0,ahp/(ally.hp+(S.equip.amulet?.hp||0))*100)+"%";
}
function msg(t){ byId("msg").textContent = t; setTimeout(()=>byId("msg").textContent="Combat auto â€” boss tous les 10 niveaux (+10 gemmes)",2000); }

/* ======= INVENTAIRE/DEX/EQUIP ======= */
function renderBag(){
  const b = byId("bag");
  if(!S.inv.length){ b.innerHTML = `<div class="small">Pas d'objets pour l'instant.</div>`; return; }
  b.innerHTML = S.inv.map((it,i)=>`
    <div class="card">
      <div class="name">${it.n}</div>
      <div class="r">${it.t.toUpperCase()} ${it.atk?`â€¢ ATK +${it.atk}`:''}${it.def?`â€¢ DEF +${it.def}`:''}${it.hp?`â€¢ PV +${it.hp}`:''}</div>
      <button class="btn" data-equip="${i}">Ã‰quiper</button>
    </div>
  `).join('');
  b.querySelectorAll("[data-equip]").forEach(btn=>{
    btn.onclick = ()=> {
      const it = S.inv[btn.dataset.equip|0];
      S.equip[it.t] = it; // 1 par catÃ©gorie
      msg(`Ã‰quipÃ© : ${it.n}`);
      save(); renderEquip();
    };
  });
}
function renderDex(){
  const has = new Set(S.collection.map(d=>d.key));
  byId("dex").innerHTML = POOL.map(d=>`
    <div class="card ${d.rarity==='RARE'?'badgeRare':''} ${d.rarity==='EPIC'?'badgeEpic':''} ${d.rarity==='LEGEND'?'badgeLegend':''} ${d.rarity==='SUPREME'?'badgeSupreme':''}">
      <div style="font-size:28px;opacity:${has.has(d.key)?1:.2}">${d.emoji}</div>
      <div class="name">${d.name}</div>
      <div class="r">${d.rarity}</div>
    </div>`).join('');
}
function renderEquip(){
  const t = byId("equipTeam");
  t.innerHTML = S.team.slice(0,5).map((d,i)=>`
    <button class="btn" data-team="${i}">${d.emoji} ${d.name}</button>
  `).join('');
  ["weapon","armor","amulet"].forEach(k=>{
    const el = byId("slot-"+k);
    const it = S.equip[k];
    el.textContent = it ? `${it.n} ${it.atk?`â€¢ATK+${it.atk}`:''}${it.def?`â€¢DEF+${it.def}`:''}${it.hp?`â€¢PV+${it.hp}`:''}` : "vide";
  });
}

/* ======= TIRAGES/COFFRES ======= */
function pull(n){
  const cost = n===1?100:1000;
  if(S.gems<cost) return msg("Pas assez de gemmes");
  S.gems -= cost; S.player.stats.gemsEarned += 0; // dÃ©jÃ  comptÃ©es Ã  l'obtention
  const got = [];
  for(let i=0;i<n;i++){
    const d = rollDino();
    got.push(d);
    S.collection.push(d);
    if(S.team.length<5) S.team.push(cloneD(d));
  }
  save(); ui(); renderDex(); useTeam();
  byId("summonResult").innerHTML = got.map(d=>`<div class="tag">${d.emoji} ${d.name} â€” ${d.rarity}</div>`).join('');
}
function openChest(kind){
  const c = CHESTS[kind]; if(!c) return;
  if(S.gold<c.cost) return msg("Pas assez d'or");
  S.gold-=c.cost;
  const it = cloneD(c.table[Math.floor(Math.random()*c.table.length)]);
  S.inv.push(it);
  save(); ui(); renderBag();
  msg(`Objet obtenu : ${it.n}`);
}

/* ======= AMÃ‰LIORATIONS ======= */
function improve(stat){
  if(S.gold<500) return msg("Pas assez d'or");
  S.gold-=500;
  if(stat==="hp") S.team[0].hp += 20;
  if(stat==="atk") S.team[0].atk += 2;
  if(stat==="def") S.team[0].def += 1;
  save(); ui(); renderAlly(); msg("AmÃ©lioration appliquÃ©e !");
}

/* ======= PROFIL/AMIS/CLASSEMENT (LOCAL) ======= */
function makeId(){ const r=()=>Math.random().toString(36).slice(2,6).toUpperCase(); return `DQ-${r()}-${r()}`; }

function renderProfile(){
  byId("profileName").value = S.player.name||"";
  byId("profileId").textContent = `ID: ${S.player.id}`;
  byId("profileStats").innerHTML = [
    {k:'kills', label:'Ennemis vaincus'},
    {k:'goldEarned', label:'Or gagnÃ©'},
    {k:'gemsEarned', label:'Gemmes gagnÃ©es'},
  ].map(it=>`<div class="card"><div class="name">${it.label}</div><div class="r">${S.player.stats[it.k]||0}</div></div>`).join('');
  byId("profileTeam").innerHTML = S.team.slice(0,5).map(d=>`
    <div class="card"><div style="font-size:28px">${d.emoji}</div><div class="name">${d.name}</div><div class="r">${d.rarity}</div></div>
  `).join('');
}
byId("saveProfile").onclick = ()=>{ S.player.name = (byId("profileName").value||"Joueur").slice(0,20); save(); msg("Profil sauvegardÃ©"); renderProfile(); };

function renderFriends(){
  const list = byId("friendsList");
  const arr = S.player.friends||[];
  list.innerHTML = (arr.length?arr:["Aucun ami"]).map(id=>`
    <div class="card"><div class="name">${id}</div>
      ${id!=="Aucun ami"?`<button class="btn" data-rm="${id}">Retirer</button>`:""}
    </div>`).join('');
  list.querySelectorAll("[data-rm]").forEach(b=>{
    b.onclick = ()=>{ S.player.friends = (S.player.friends||[]).filter(x=>x!==b.dataset.rm); save(); renderFriends(); };
  });
};
byId("addFriendBtn").onclick = ()=>{
  const v = byId("friendId").value.trim();
  if(!/^DQ-[A-Z0-9]{4}-[A-Z0-9]{4}$/.test(v)) return alert("ID invalide (ex: DQ-AB12-CD34)");
  S.player.friends = S.player.friends||[];
  if(!S.player.friends.includes(v)) S.player.friends.push(v);
  save(); byId("friendId").value=""; renderFriends();
};

function score(){ return (S.player.stats.kills||0) + Math.floor((S.gold||0)/100) + Math.floor((S.gems||0)/50); }
function renderRank(){
  const fake = [
    {name:'Rex', id:'DQ-AAAA-BBBB', score:120},
    {name:'Nyla', id:'DQ-CCCC-DDDD', score:95},
    {name:'Zed', id:'DQ-EEEE-FFFF', score:80},
  ];
  const me = {name:S.player.name||"Moi", id:S.player.id, score:score()};
  const all = [...fake,me].sort((a,b)=>b.score-a.score).slice(0,12);
  byId("rankList").innerHTML = all.map(u=>`
    <div class="card" style="${u.id===S.player.id?'outline:2px solid #22d3ee':''}">
      <div class="name">${u.name}</div>
      <div class="r">${u.id}</div>
      <div class="tag">Score: ${u.score}</div>
    </div>`).join('');
}

/* ======= PROMO ======= */
byId("applyPromo").onclick = ()=>{
  const c = (byId("promoInput").value||"").trim().toUpperCase();
  if(c==="TESTDINO"){
    S.gold += 200000; S.gems += 50000;
    save(); ui(); msg("Bonus appliquÃ© !");
  }else msg("Code invalide");
};

/* ======= MENU & SHEETS ======= */
const ham = byId("ham"), menu = byId("menu");
ham.addEventListener("click",(e)=>{ e.stopPropagation(); menu.classList.toggle("open"); ham.setAttribute("aria-expanded", menu.classList.contains("open")); });
menu.addEventListener("click",(e)=> e.stopPropagation());
document.addEventListener("click",()=>{ if(menu.classList.contains("open")){ menu.classList.remove("open"); ham.setAttribute("aria-expanded","false"); }});

function openSheet(name){ byId("sheet-"+name).classList.add("open"); }
function closeAllSheets(){ document.querySelectorAll(".sheet").forEach(s=>s.classList.remove("open")); }
document.querySelectorAll('#menu a[data-tab]').forEach(a=>{
  a.addEventListener('click',(e)=>{
    e.preventDefault(); closeAllSheets();
    const t = a.dataset.tab;
    if(t==='improve') openSheet('improve');
    else if(t==='summon'){ renderBag(); openSheet('summon'); }
    else if(t==='bag'){ renderBag(); openSheet('bag'); }
    else if(t==='dex'){ renderDex(); openSheet('dex'); }
    else if(t==='equip'){ renderEquip(); openSheet('equip'); }
    else if(t==='promo'){ openSheet('promo'); }
    else if(t==='profile'){ renderProfile(); openSheet('profile'); }
    else if(t==='friends'){ renderFriends(); openSheet('friends'); }
    else if(t==='rank'){ renderRank(); openSheet('rank'); }
  });
});
byId("reset").onclick = ()=>{ if(confirm("Effacer la sauvegarde ?")){ localStorage.removeItem("dq_save"); location.reload(); }};

/* ======= HOOKS UI ======= */
document.querySelectorAll(".speed button").forEach(b=> b.onclick=()=>{ S.speed = b.dataset.sp|0; save(); msg("Vitesse x"+S.speed); });
document.querySelectorAll("[data-up]").forEach(b=> b.onclick=()=> improve(b.dataset.up));
byId("pull1").onclick = ()=> pull(1);
byId("pull10").onclick = ()=> pull(10);
document.querySelectorAll("[data-chest]").forEach(b=> b.onclick=()=> openChest(b.dataset.chest));

/* ======= INIT ======= */
function firstStart(){
  if(!S.collection.length){ S.collection.push(cloneD(POOL[0])); }
  if(!S.team.length){ S.team.push(cloneD(POOL[0])); }
}
firstStart(); ui(); setWorld(S.lvl); useTeam(); renderDex(); renderBag();
let last=performance.now(); requestAnimationFrame(function loop(t){ const dt=(t-last)/1000; last=t; tick(dt); });
</script>
</body>
</html>
