<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dino Quest</title>
<style>
:root{
  --bg:#0b0f14; --bg2:#0f1622; --panel:#101826; --panel2:#0d1320;
  --ring:#0fa3ff; --hp:#24d3ee; --gold:#cdd6f4; --gem:#7dd3fc;
  --ok:#86efac; --warn:#fde68a; --bad:#fca5a5;
  --text:#e6edf6; --muted:#9fb0c3; --border:#1e293b;
  --shadow:0 8px 30px rgba(0,0,0,.35);
}
/* Reset + base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: radial-gradient(90vmax 60vmax at 30% -10%, #0f2a44 0%, transparent 55%),
              radial-gradient(80vmax 60vmax at 100% 0%, #10243a 0%, transparent 50%),
              linear-gradient(180deg,var(--bg2),var(--bg));
  overflow:hidden;
}
/* HUD top */
.top{
  position:fixed; inset:0 0 auto 0; height:58px; display:flex; align-items:center; justify-content:space-between;
  padding:0 12px; background:linear-gradient(180deg,rgba(16,24,38,.85),rgba(16,24,38,.35) 70%, transparent);
  border-bottom:1px solid var(--border); z-index:40;
}
.brand{font-weight:800; letter-spacing:.5px}
.hud{display:flex; gap:8px; align-items:center; font-weight:700}
.badge{display:flex; gap:6px; align-items:center; padding:6px 10px;
  border:1px solid var(--border); border-radius:12px; background:var(--panel); box-shadow:var(--shadow); }
.g{color:var(--gold)} .j{color:var(--gem)}
.ham{width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:var(--panel);display:grid;place-items:center}
.ham span{width:16px;height:2px;background:#9fb0c3;position:relative;display:block}
.ham span:before,.ham span:after{content:"";position:absolute;left:0;width:100%;height:2px;background:#9fb0c3}
.ham span:before{top:-6px} .ham span:after{top:6px}

/* Stage */
.stage{position:absolute; inset:58px 0 0 0; overflow:hidden}
.scene{position:absolute; inset:16px 16px 16px 16px; border-radius:18px;
  background: radial-gradient(80vmax 50vmax at 50% 20%, rgba(29,78,216,.18), transparent 60%),
              radial-gradient(60vmax 40vmax at 50% 100%, rgba(14,165,233,.12), transparent 55%);
  border:1px solid var(--border);
}
.hint{position:absolute; top:18px; left:calc(50% - 260px); width:520px; max-width:calc(100% - 32px);
  color:#b7e4c7; background:rgba(16,38,30,.6); border:1px dashed #2dd4bf; border-radius:12px; padding:12px;
}
.enemyCard{position:absolute; right:28px; top:110px; width:320px; border-radius:16px; background:linear-gradient(180deg,#0f1c2c,#0c1524);
  padding:14px; border:1px solid var(--border); box-shadow:var(--shadow)
}
.cardTitle{font-weight:800; font-size:20px; margin-bottom:8px}
.bar{height:10px;background:#0b1220;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.bar>i{display:block;height:100%;background:var(--hp);width:100%}
.stat{color:var(--muted); font-weight:700;letter-spacing:.3px;margin-top:8px}

.teamRow{position:absolute; left:22px; bottom:110px; right:22px; height:72px; display:flex; gap:12px; align-items:center}
.teCard{flex:1; min-width:130px; max-width:240px; border-radius:16px; background:linear-gradient(180deg,#0e1928,#0b1422);
  border:1px solid var(--border); padding:12px; position:relative}
.teName{font-weight:800}
.hpbar{height:8px;margin-top:6px;background:#0a1120;border-radius:8px;border:1px solid var(--border);overflow:hidden}
.hpbar>i{display:block;height:100%;background:var(--hp);width:100%}

/* Sprites */
.sprite, .enemySprite{
  position:absolute; font-size:64px; filter: drop-shadow(0 12px 20px rgba(0,0,0,.5));
  animation: idle 2.4s ease-in-out infinite;
}
.sprite{left:60px; bottom:205px}
.enemySprite{right:110px; bottom:260px}
@keyframes idle{0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)}}

/* Vitesse */
.speedBox{position:absolute; right:16px; bottom:20px; display:flex; gap:8px; align-items:center}
.speedBox .chip{border:1px solid var(--border); background:var(--panel); border-radius:12px; padding:8px 12px; color:var(--muted)}
.speedBox .btn{padding:8px 12px;border:1px solid var(--border);border-radius:12px;background:var(--panel);}
.speedBox .btn.on{outline:2px solid #4f46e5}

/* Particules */
.particle{position:absolute; pointer-events:none; font-size:18px; animation: pop .5s ease-out forwards}
@keyframes pop{from{opacity:1; transform:translateY(0) scale(1)} to{opacity:0; transform:translateY(-18px) scale(1.2)}}

/* Menu & Panels */
.menu{position:fixed; top:56px; right:14px; width:240px; background:var(--panel); border:1px solid var(--border); border-radius:16px;
  padding:8px; box-shadow:var(--shadow); display:none; z-index:50}
.menu.open{display:block}
.menu a{display:block; padding:10px 12px; border-radius:10px; color:var(--text); text-decoration:none}
.menu a:hover{background:rgba(148,163,184,.12)}

.panel{
  position:fixed; inset:0; display:none; z-index:60; background: radial-gradient(200vmax 120vmax at 50% -20%, rgba(59,130,246,.15), transparent 40%),
                                                  linear-gradient(180deg, rgba(2,6,23,.9), rgba(2,6,23,.75));
  backdrop-filter: blur(6px);
}
.panel.open{display:block}
.panel .wrap{position:absolute; inset:70px 16px 16px 16px; border:1px solid var(--border); border-radius:16px; background:var(--panel2); padding:16px; overflow:auto}
.panel h2{margin:0 0 12px 0}
.pbar{height:8px;background:#0a1120;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.pbar>i{display:block;height:100%;background:var(--hp);width:0}
.grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
@media(min-width:560px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
@media(min-width:820px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
.tile{border:1px solid var(--border); background:linear-gradient(180deg,#0d1626,#0b1322); padding:12px; border-radius:14px}
.kv{display:flex; justify-content:space-between; color:var(--muted); font-weight:700}
.row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
.btn,.sec{
  display:inline-flex; gap:8px; align-items:center; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--panel);
  color:var(--text); text-decoration:none; font-weight:700;
}
.sec{background:transparent}
.hr{height:1px;background:var(--border);margin:12px 0}
.bad{color:var(--bad)} .ok{color:var(--ok)}

.back{position:absolute; left:14px; top:14px}

/* Toast */
.toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background:#111827dd; color:#e5e7eb; border:1px solid #374151; border-radius:12px; padding:10px 14px; z-index:90; display:none}
.toast.show{display:block}

/* Debug label (en bas Ã  gauche) â€“ tu peux enlever .debug pour masquer */
.debug{position:fixed; left:10px; bottom:10px; background:#1f2937cc; border:1px solid #374151; padding:6px 10px; border-radius:10px; font-weight:700}
</style>
</head>
<body>

<!-- HUD -->
<header class="top">
  <div class="brand">Dino<br>Quest</div>
  <div class="hud">
    <div class="badge">Lvl&nbsp;<span id="lvl">1</span></div>
    <div class="badge g">ğŸª™&nbsp;<span id="gold">0</span></div>
    <div class="badge j">ğŸ’&nbsp;<span id="gems">0</span></div>
    <button id="ham" class="ham" aria-label="menu" aria-expanded="false"><span></span></button>
  </div>
</header>

<!-- Menu -->
<nav id="menu" class="menu">
  <a href="#" data-tab="improve">AmÃ©liorations</a>
  <a href="#" data-tab="summon">Tirage</a>
  <a href="#" data-tab="bag">Inventaire</a>
  <a href="#" data-tab="dex">Classeur</a>
  <a href="#" data-tab="shop">Boutique</a>
  <a href="#" data-tab="promo">Code Promo</a>
</nav>

<!-- Stage combat -->
<div class="stage">
  <div class="scene" id="scene">
    <div class="hint" id="hint">Combat auto â€” Boss toutes les 15 zones (+10 ğŸ’)</div>

    <div class="enemyCard" id="enemyCard">
      <div class="cardTitle" id="enemyName">Niv. 1 â€” LÃ©zard Sauvage</div>
      <div class="bar"><i id="enemyHP"></i></div>
      <div class="stat" id="enemyStats">ATK 6 â€¢ DEF 2</div>
    </div>

    <!-- sprites -->
    <div id="allySprite" class="sprite">ğŸ¦•</div>
    <div id="enemySprite" class="enemySprite">ğŸ¦</div>

    <!-- barre Ã©quipe -->
    <div class="teamRow" id="teamRow"></div>

    <!-- vitesse -->
    <div class="speedBox">
      <span class="chip">Vitesse dâ€™attaque</span>
      <button class="btn on" data-speed="1">x1</button>
      <button class="btn" data-speed="2">x2</button>
      <button class="btn" data-speed="3">x3</button>
    </div>
  </div>
</div>

<!-- PANELS -->
<div id="panel-improve" class="panel">
  <div class="wrap">
    <button class="sec back" data-close>â† Retour</button>
    <h2>AmÃ©liorations</h2>
    <div id="improveWrap" class="grid"></div>
  </div>
</div>

<div id="panel-summon" class="panel">
  <div class="wrap">
    <button class="sec back" data-close>â† Retour</button>
    <h2>Tirage</h2>
    <div class="row">
      <button class="btn" id="pull1">Tirage unique (100 ğŸ’)</button>
      <button class="btn" id="pull10">Tirage x10 (900 ğŸ’)</button>
    </div>
    <div class="hr"></div>
    <div id="summonResult" class="grid"></div>
  </div>
</div>

<div id="panel-bag" class="panel">
  <div class="wrap">
    <button class="sec back" data-close>â† Retour</button>
    <h2>Inventaire</h2>
    <div id="bagWrap" class="grid"></div>
  </div>
</div>

<div id="panel-dex" class="panel">
  <div class="wrap">
    <button class="sec back" data-close>â† Retour</button>
    <h2>Classeur</h2>
    <div id="dexWrap" class="grid"></div>
  </div>
</div>

<div id="panel-shop" class="panel">
  <div class="wrap">
    <button class="sec back" data-close>â† Retour</button>
    <h2>Boutique</h2>
    <div class="row">
      <button class="btn" id="daily">Coffre quotidien (gratuit)</button>
      <button class="btn" id="buyGold">+10 000 ğŸª™ (100 ğŸ’)</button>
    </div>
  </div>
</div>

<div id="panel-promo" class="panel">
  <div class="wrap">
    <button class="sec back" data-close>â† Retour</button>
    <h2>Code promo</h2>
    <div class="row">
      <input id="promoInput" class="btn" style="width:220px" placeholder="Codeâ€¦">
      <button class="btn" id="applyPromo">Valider</button>
    </div>
    <p class="muted">Astuce : <span class="ok">MEGA-START</span> pour tester.</p>
  </div>
</div>

<div id="toast" class="toast"></div>
<div class="debug" id="debug">debug : ok</div>

<script>
/*------------------------- STATE -------------------------*/
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

const POOL = [
  {id:'raptor', name:'Petit Raptor', emoji:'ğŸ¦•', rarity:'BASIC', hp:120, atk:8, def:2, spd:1.2},
  {id:'trike',  name:'Trihorn',      emoji:'ğŸ¦–', rarity:'RARE',  hp:160, atk:12, def:4, spd:1.2},
  {id:'ptero',  name:'AÃ©roptÃ¨re',    emoji:'ğŸ¦…', rarity:'EPIC',  hp:140, atk:16, def:3, spd:1.0},
  {id:'rex',    name:'Rex Alpha',    emoji:'ğŸ¦‚', rarity:'LEG',   hp:180, atk:22, def:6, spd:1.1},
  {id:'spino',  name:'Spino SuprÃªme',emoji:'ğŸ‰', rarity:'SUP',   hp:220, atk:30, def:8, spd:0.9}
];

const ITEMS = [
  {id:'sword1', cat:'atk',  name:'Griffe aiguisÃ©e',  val:+4,  rarity:'BASIC'},
  {id:'shield1',cat:'def',  name:'Cuirasse osseuse', val:+2,  rarity:'BASIC'},
  {id:'heart1', cat:'hp',   name:'Ã‰caille vitale',   val:+20, rarity:'BASIC'},
  {id:'sword2', cat:'atk',  name:'Crocs runiques',   val:+8,  rarity:'RARE'},
  {id:'shield2',cat:'def',  name:'Carapace dure',    val:+4,  rarity:'RARE'},
  {id:'heart2', cat:'hp',   name:'Noyau primal',     val:+40, rarity:'RARE'},
  {id:'sword3', cat:'atk',  name:'Lame du ciel',     val:+12, rarity:'EPIC'},
  {id:'shield3',cat:'def',  name:'Bouclier onyx',    val:+6,  rarity:'EPIC'},
  {id:'heart3', cat:'hp',   name:'CÅ“ur draconique',  val:+60, rarity:'EPIC'},
  {id:'sword4', cat:'atk',  name:'Crocs stellaires', val:+18, rarity:'LEG'},
  {id:'shield4',cat:'def',  name:'Mur dâ€™obsidienne', val:+10, rarity:'LEG'},
  {id:'heart4', cat:'hp',   name:'Sang ancestral',   val:+90, rarity:'LEG'},
  {id:'sword5', cat:'atk',  name:'Ã‰pÃ©e suprÃªme',     val:+26, rarity:'SUP'},
  {id:'shield5',cat:'def',  name:'Rempart suprÃªme',  val:+16, rarity:'SUP'},
  {id:'heart5', cat:'hp',   name:'CÅ“ur suprÃªme',     val:+140,rarity:'SUP'}
];

const rarityColor = {BASIC:'#64748b', RARE:'#38bdf8', EPIC:'#a78bfa', LEG:'#f59e0b', SUP:'#f43f5e'};

const S = {
  lvl:1, zone:1, speed:1,
  gold:0, gems:0,
  collection:[], // tous les dinos acquis
  team:[],       // 1..5 actifs
  bag:[],        // objets
  equip: {},     // equip[ dinoId ] = {atk:id, def:id, hp:id}
  enemy:null,
  last: performance.now()
};

/*--------------------- UTIL UI ---------------------*/
function toast(msg, ms=1500){
  const t=$("#toast"); t.textContent=msg; t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), ms);
}
function openPanel(id){ $(`#panel-${id}`).classList.add("open"); }
function closePanels(){ $$(".panel").forEach(p=>p.classList.remove("open")); }

/*--------------------- INIT ---------------------*/
function cloneDino(d){
  return {uid:crypto.randomUUID(), ...d, curHP:d.hp, lvl:1, exp:0};
}
function baseSetup(){
  if(!S.collection.length){
    const base = POOL.find(d=>d.rarity==="BASIC");
    S.collection=[ cloneDino(base) ];
  }
  if(!S.team.length){
    S.team=[ {...S.collection[0]} ];
  }
  setWorld(S.lvl);
  newEnemy();
  ui();
  renderTeam();
}
function setWorld(lvl){
  $("#lvl").textContent = lvl;
}

/*--------------------- ENEMY ---------------------*/
function newEnemy(){
  const pool = ["ğŸ¦","ğŸ¦‚","ğŸ¦–","ğŸ","ğŸ¦ˆ"];
  const emoji = pool[rand(0,pool.length-1)];
  const hp = 80 + S.lvl*20;
  const atk = 6 + Math.floor(S.lvl*1.5);
  const def = 2 + Math.floor(S.lvl/3);
  S.enemy = {name:`Niv. ${S.lvl} â€” LÃ©zard Sauvage`, emoji, hp, cur:hp, atk, def};
  $("#enemyName").textContent = S.enemy.name;
  $("#enemyStats").textContent = `ATK ${atk} â€¢ DEF ${def}`;
  $("#enemyHP").style.width = "100%";
  $("#enemySprite").textContent = emoji;
}

/*--------------------- RENDER ---------------------*/
function renderTeam(){
  const row=$("#teamRow"); row.innerHTML="";
  const max = Math.max(1, Math.min(5, S.team.length));
  for(let i=0;i<max;i++){
    const d = S.team[i] || S.collection[0];
    const card = document.createElement("div");
    card.className="teCard";
    card.innerHTML = `
       <div class="teName">${d.name} â€” <span style="color:${rarityColor[d.rarity]}">${d.rarity}</span></div>
       <div class="hpbar"><i style="width:${Math.round(d.curHP/d.hp*100)}%"></i></div>
       <div class="stat">PV ${d.curHP}/${d.hp} â€¢ ATK ${totalAtk(d)} â€¢ DEF ${totalDef(d)}</div>
    `;
    row.appendChild(card);
  }
  $("#allySprite").textContent = (S.team[0]||S.collection[0]).emoji;
}

function ui(){
  $("#gold").textContent = S.gold;
  $("#gems").textContent = S.gems;
}

/*--------------------- STATS + EQUIP ---------------------*/
function eqFor(d){
  return S.equip[d.uid] || (S.equip[d.uid]={});
}
function totalAtk(d){
  const eq = eqFor(d);
  const bonus = [eq.atk, eq.atk2].filter(Boolean).map(id=>ITEMS.find(i=>i.id===id)?.val||0).reduce((a,b)=>a+b,0);
  return d.atk + bonus + Math.floor((d.lvl-1)*1.5);
}
function totalDef(d){
  const eq = eqFor(d);
  const bonus = [eq.def].filter(Boolean).map(id=>ITEMS.find(i=>i.id===id)?.val||0).reduce((a,b)=>a+b,0);
  return d.def + bonus + Math.floor((d.lvl-1)*0.8);
}

/*--------------------- COMBAT LOOP ---------------------*/
function hit(from, to, power, isEnemy=false){
  const n = document.createElement("div");
  n.className="particle";
  n.style.left = (isEnemy? (window.innerWidth-160) : 120) + rand(-10,10) + "px";
  n.style.top  = (isEnemy?  (window.innerHeight-330) : (window.innerHeight-180)) + rand(-8,8) + "px";
  n.textContent = "âœ§";
  document.body.appendChild(n);
  setTimeout(()=>n.remove(), 520);

  const dmg = Math.max(1, power - to.def);
  to.cur = clamp(to.cur - dmg, 0, to.cur);
  return dmg;
}

function loop(now){
  const dt = (now - S.last)/1000; S.last = now;
  const step = dt * (S.speed||1);

  // Allies attack sequentially
  if(S.enemy && S.enemy.cur>0){
    for(let i=0;i<Math.min(5,S.team.length);i++){
      const d = S.team[i]; if(!d) continue;
      d._t = (d._t || 0) + step;
      const period = (d.spd || 1.2) / (S.speed||1);
      if(d._t >= period){
        d._t = 0;
        const power = totalAtk(d);
        hit(d, S.enemy, power, false);
        S.enemy.cur = clamp(S.enemy.cur - Math.max(1, power - S.enemy.def), 0, S.enemy.hp);
      }
    }
  }

  // Enemy retaliates random ally
  if(S.enemy && S.enemy.cur>0){
    S.enemy._t = (S.enemy._t||0) + step;
    if(S.enemy._t >= 1.2/(S.speed||1)){ // enemy speed
      S.enemy._t = 0;
      const idx = rand(0, Math.min(4,S.team.length-1));
      const d = S.team[idx]; if(d){
        hit(S.enemy, d, S.enemy.atk, true);
        d.curHP = clamp(d.curHP - Math.max(1, S.enemy.atk - totalDef(d)), 0, d.hp);
      }
    }
  }

  // Update bars
  if(S.enemy){
    $("#enemyHP").style.width = (S.enemy.cur/S.enemy.hp*100) + "%";
  }
  renderTeam();

  // Victory / Defeat
  if(S.enemy && S.enemy.cur<=0){
    S.gold += 10 + S.lvl*6;
    if(S.lvl%15===0) S.gems += 10;
    S.lvl++; ui(); setWorld(S.lvl); newEnemy();
  }else{
    // team dead ?
    const alive = S.team.some(d=>d.curHP>0);
    if(!alive){
      // retour dÃ©but de la zone
      S.team.forEach(d=>d.curHP=d.hp);
      toast("Ã‰quipe vaincue â€” on retente la zone !");
    }
  }

  requestAnimationFrame(loop);
}

/*--------------------- PANELS CONTENT ---------------------*/
function renderImprove(){
  const w=$("#improveWrap"); w.innerHTML="";
  S.team.slice(0,5).forEach(d=>{
    const eq=eqFor(d);
    const t=document.createElement('div'); t.className="tile";
    t.innerHTML=`
      <div class="kv"><b>${d.name}</b><span style="color:${rarityColor[d.rarity]}">${d.rarity}</span></div>
      <div class="row" style="margin-top:6px">
        <button class="btn" data-up="hp"  data-id="${d.uid}">+20 PV (500ğŸª™)</button>
        <button class="btn" data-up="atk" data-id="${d.uid}">+2 ATK (500ğŸª™)</button>
        <button class="btn" data-up="def" data-id="${d.uid}">+1 DEF (500ğŸª™)</button>
      </div>
      <div class="hr"></div>
      <div class="kv">Ã‰quipement</div>
      <div class="row">
        <button class="sec" data-eq="atk" data-id="${d.uid}">ATK: ${eq.atk? ITEMS.find(i=>i.id===eq.atk).name : 'â€”'}</button>
        <button class="sec" data-eq="def" data-id="${d.uid}">DEF: ${eq.def? ITEMS.find(i=>i.id===eq.def).name : 'â€”'}</button>
        <button class="sec" data-eq="hp"  data-id="${d.uid}">PV: ${eq.hp?  ITEMS.find(i=>i.id===eq.hp ).name : 'â€”'}</button>
      </div>
    `;
    w.appendChild(t);
  });

  w.querySelectorAll("[data-up]").forEach(b=>{
    b.onclick=()=>{
      const d = S.team.find(x=>x.uid===b.dataset.id); if(!d) return;
      if(S.gold<500){ toast("Pas assez dâ€™or"); return; }
      S.gold-=500;
      if(b.dataset.up==="hp"){ d.hp+=20; d.curHP+=20; }
      if(b.dataset.up==="atk"){ d.atk+=2; }
      if(b.dataset.up==="def"){ d.def+=1; }
      ui(); renderImprove(); renderTeam();
    };
  });
  // equip depuis inventaire
  w.querySelectorAll("[data-eq]").forEach(b=>{
    b.onclick=()=>{
      const d = S.team.find(x=>x.uid===b.dataset.id); if(!d) return;
      // filtre items compatibles
      const list = S.bag.filter(i=>i.cat===b.dataset.eq);
      if(!list.length){ toast("Aucun objet compatible"); return; }
      const it = list[0];
      eqFor(d)[b.dataset.eq] = it.id;
      // retirer 1 de l'inventaire
      const idx = S.bag.findIndex(x=>x===it); if(idx>-1) S.bag.splice(idx,1);
      renderImprove(); renderTeam();
    };
  });
}

function renderBag(){
  const w=$("#bagWrap"); w.innerHTML="";
  if(!S.bag.length){ w.innerHTML='<div class="tile">Inventaire vide</div>'; return; }
  S.bag.forEach(it=>{
    const t=document.createElement('div'); t.className="tile";
    t.innerHTML=`<div class="kv"><b>${it.name}</b><span style="color:${rarityColor[it.rarity]}">${it.rarity}</span></div>
                 <div class="muted">+${it.val} ${it.cat.toUpperCase()}</div>`;
    w.appendChild(t);
  });
}
function renderDex(){
  const w=$("#dexWrap"); w.innerHTML="";
  const have=new Set(S.collection.map(d=>d.id));
  POOL.forEach(d=>{
    const got = have.has(d.id);
    const t=document.createElement('div'); t.className="tile";
    t.style.opacity = got? 1 :.4;
    t.innerHTML=`<div class="kv"><b>${d.name}</b><span style="color:${rarityColor[d.rarity]}">${d.rarity}</span></div>
                 <div style="font-size:40px;margin-top:8px">${d.emoji}</div>`;
    w.appendChild(t);
  });
}

/*--------------------- SUMMON + SHOP + PROMO ---------------------*/
function grantItem(r){
  const pool = ITEMS.filter(x=>x.rarity===r);
  return {...pool[rand(0,pool.length-1)]};
}
function grantDino(r){
  const pool = POOL.filter(x=>x.rarity===r);
  return cloneDino(pool[rand(0,pool.length-1)]);
}
function rollRarity(kind="dino"){
  // dino rates
  if(kind==="dino"){
    const r = Math.random();
    if(r<0.50) return "BASIC";
    if(r<0.80) return "RARE";
    if(r<0.94) return "EPIC";
    if(r<0.995) return "LEG";
    return "SUP";
  }else{ // item chest
    const r = Math.random();
    if(r<0.55) return "BASIC";
    if(r<0.83) return "RARE";
    if(r<0.95) return "EPIC";
    if(r<0.995) return "LEG";
    return "SUP";
  }
}
function doPull(n){
  const cost = n===10? 900 : 100;
  if(S.gems<cost){ toast("Pas assez de gemmes"); return; }
  S.gems-=cost; ui();
  const wrap=$("#summonResult"); wrap.innerHTML="";
  for(let i=0;i<n;i++){
    const isDino = Math.random()<0.6; // 60% dino, 40% item
    if(isDino){
      const d = grantDino(rollRarity("dino")); S.collection.push(d);
      const t=document.createElement('div'); t.className="tile"; t.style.borderColor=rarityColor[d.rarity];
      t.innerHTML=`<div class="kv"><b>${d.name}</b><span style="color:${rarityColor[d.rarity]}">${d.rarity}</span></div>
                   <div style="font-size:38px;margin-top:6px">${d.emoji}</div>`;
      wrap.appendChild(t);
    }else{
      const it = grantItem(rollRarity("item")); S.bag.push(it);
      const t=document.createElement('div'); t.className="tile"; t.style.borderColor=rarityColor[it.rarity];
      t.innerHTML=`<div class="kv"><b>${it.name}</b><span style="color:${rarityColor[it.rarity]}">${it.rarity}</span></div>
                   <div class="muted">+${it.val} ${it.cat.toUpperCase()}</div>`;
      wrap.appendChild(t);
    }
  }
  renderDex(); renderBag();
}
function dailyChest(){
  const key="dino_daily";
  const last=+localStorage.getItem(key)||0;
  const now=Date.now();
  if(now-last<24*3600*1000){ toast("DÃ©jÃ  pris aujourdâ€™hui"); return; }
  localStorage.setItem(key, now);
  S.gold+=rand(500,2000); S.gems+=10; ui(); toast("Coffre quotidien ouvert !");
}
function applyPromo(code){
  if(code==="MEGA-START" && !localStorage.getItem("promo_ms")){
    localStorage.setItem("promo_ms","1");
    S.gold+=200000; S.gems+=50000; ui(); toast("Bonus ajoutÃ© !");
  }else{
    toast("Code invalide ou dÃ©jÃ  utilisÃ©");
  }
}

/*--------------------- MENU + PANELS + SPEED ---------------------*/
function hooks(){
  // hamburger
  const ham=$("#ham"), menu=$("#menu");
  ham.addEventListener("click",(e)=>{
    e.stopPropagation();
    const open = !menu.classList.contains("open");
    menu.classList.toggle("open", open);
    ham.setAttribute("aria-expanded", open?"true":"false");
  });
  document.addEventListener("click",(e)=>{
    if(!menu.classList.contains("open")) return;
    if(e.target.closest("#menu")||e.target.closest("#ham")) return;
    menu.classList.remove("open"); ham.setAttribute("aria-expanded","false");
  }, {capture:true});

  // open panels
  $$("#menu a").forEach(a=>{
    a.onclick=(ev)=>{
      ev.preventDefault();
      menu.classList.remove("open"); ham.setAttribute("aria-expanded","false");
      const tab=a.dataset.tab;
      if(tab==="improve"){ renderImprove(); }
      if(tab==="bag"){ renderBag(); }
      if(tab==="dex"){ renderDex(); }
      openPanel(tab);
    };
  });
  // back buttons
  $$("[data-close]").forEach(b=>b.onclick=()=>closePanels());

  // speed
  $$("[data-speed]").forEach(b=>{
    b.onclick=()=>{
      S.speed=+b.dataset.speed;
      $$("[data-speed]").forEach(x=>x.classList.toggle("on", x===b));
    };
  });

  // summon
  $("#pull1").onclick=()=>doPull(1);
  $("#pull10").onclick=()=>doPull(10);

  // shop
  $("#daily").onclick=dailyChest;
  $("#buyGold").onclick=()=>{
    if(S.gems<100){ toast("Pas assez de gemmes"); return; }
    S.gems-=100; S.gold+=10000; ui(); toast("+10 000 or");
  };

  // promo
  $("#applyPromo").onclick=()=>{
    applyPromo( ($("#promoInput").value||"").trim().toUpperCase() );
  };
}

/*--------------------- START ---------------------*/
function start(){
  baseSetup();
  hooks();
  // init speed buttons state
  $$("[data-speed]").forEach(b=>b.classList.toggle("on", +b.dataset.speed===S.speed));
  requestAnimationFrame(t=>{ S.last=t; loop(t); });
}

start();
</script>
</body>
</html>
